<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>é›†æˆæ¸¬è©¦å¥—ä»¶ - Integration Test Suite</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }
    .container { max-width: 1400px; margin: 0 auto; }
    h1 {
      color: white;
      text-align: center;
      margin-bottom: 30px;
      font-size: 28px;
    }
    .test-panel {
      background: white;
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }
    .test-panel h2 {
      color: #333;
      margin-bottom: 15px;
      border-bottom: 2px solid #667eea;
      padding-bottom: 10px;
    }
    .controls {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 10px;
      margin-bottom: 20px;
    }
    button {
      padding: 12px 20px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-weight: 600;
      font-size: 13px;
      transition: all 0.2s;
    }
    .btn-primary { background: #667eea; color: white; }
    .btn-primary:hover { background: #5568d3; }
    .btn-success { background: #48bb78; color: white; }
    .btn-success:hover { background: #38a169; }
    .btn-danger { background: #f56565; color: white; }
    .btn-danger:hover { background: #e53e3e; }
    .output {
      background: #1a202c;
      color: #68d391;
      font-family: 'Courier New', monospace;
      padding: 15px;
      border-radius: 6px;
      max-height: 500px;
      overflow-y: auto;
      font-size: 12px;
      line-height: 1.6;
    }
    .output-line {
      margin-bottom: 4px;
    }
    .pass { color: #68d391; }
    .fail { color: #fc8181; }
    .skip { color: #f6d55c; }
    .info { color: #63b3ed; }
    .summary {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 15px;
      margin-top: 20px;
    }
    .summary-card {
      background: #f0fdf4;
      border-left: 4px solid #48bb78;
      padding: 15px;
      border-radius: 4px;
    }
    .summary-card h3 {
      font-size: 12px;
      color: #166534;
      margin-bottom: 8px;
      text-transform: uppercase;
    }
    .summary-card p {
      font-size: 24px;
      font-weight: 700;
      color: #059669;
      margin: 0;
    }
    .summary-card.error {
      background: #fee2e2;
      border-left-color: #f56565;
    }
    .summary-card.error h3 { color: #7f1d1d; }
    .summary-card.error p { color: #dc2626; }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸ§ª ç³»çµ±é›†æˆæ¸¬è©¦å¥—ä»¶</h1>

    <!-- åŠŸèƒ½é›†æˆæ¸¬è©¦ -->
    <div class="test-panel">
      <h2>âœ“ åŠŸèƒ½é›†æˆæ¸¬è©¦</h2>
      <div class="controls">
        <button class="btn-primary" onclick="runFunctionalTests()">â–¶ é‹è¡Œæ‰€æœ‰åŠŸèƒ½æ¸¬è©¦</button>
        <button class="btn-success" onclick="runSearchTests()">ğŸ” æœå°‹åŠŸèƒ½æ¸¬è©¦</button>
        <button class="btn-success" onclick="runFilterTests()">ğŸ”½ ç¯©é¸åŠŸèƒ½æ¸¬è©¦</button>
        <button class="btn-success" onclick="runUXTests()">âœ¨ UX å¢å¼·æ¸¬è©¦</button>
      </div>
      <div class="output" id="functional-output"></div>
    </div>

    <!-- æ€§èƒ½åŸºæº–æ¸¬è©¦ -->
    <div class="test-panel">
      <h2>âš¡ æ€§èƒ½åŸºæº–æ¸¬è©¦</h2>
      <div class="controls">
        <button class="btn-primary" onclick="runPerformanceBenchmarks()">â–¶ é‹è¡Œæ€§èƒ½åŸºæº–æ¸¬è©¦</button>
        <button class="btn-success" onclick="benchmarkSearch()">ğŸ” æœå°‹æ€§èƒ½</button>
        <button class="btn-success" onclick="benchmarkFilter()">ğŸ”½ ç¯©é¸æ€§èƒ½</button>
        <button class="btn-success" onclick="benchmarkMemory()">ğŸ’¾ å…§å­˜ä½¿ç”¨</button>
      </div>
      <div class="output" id="performance-output"></div>
    </div>

    <!-- æ‡‰ç”¨å ´æ™¯æ¸¬è©¦ -->
    <div class="test-panel">
      <h2>ğŸ¯ æ‡‰ç”¨å ´æ™¯æ¸¬è©¦ (E2E)</h2>
      <div class="controls">
        <button class="btn-primary" onclick="runE2ETests()">â–¶ é‹è¡Œæ‰€æœ‰æ‡‰ç”¨å ´æ™¯</button>
        <button class="btn-success" onclick="runScenario1()">å ´æ™¯ 1: åŸºæœ¬ç¯©é¸</button>
        <button class="btn-success" onclick="runScenario2()">å ´æ™¯ 2: è¤‡é›œæŸ¥è©¢</button>
        <button class="btn-success" onclick="runScenario3()">å ´æ™¯ 3: é‚Šç•Œæƒ…æ³</button>
      </div>
      <div class="output" id="e2e-output"></div>
    </div>

    <!-- æ¸¬è©¦çµ±è¨ˆ -->
    <div class="test-panel">
      <h2>ğŸ“Š æ¸¬è©¦çµ±è¨ˆ</h2>
      <div class="summary" id="test-summary"></div>
    </div>

    <!-- æ—¥èªŒé¢æ¿ -->
    <div class="test-panel">
      <h2>ğŸ“‹ ç³»çµ±æ—¥èªŒ</h2>
      <div class="controls">
        <button class="btn-danger" onclick="clearAllLogs()">æ¸…ç©ºæ—¥èªŒ</button>
      </div>
      <div class="output" id="system-log"></div>
    </div>
  </div>

  <!-- å¼•å…¥æ¸¬è©¦æ¡†æ¶å’Œä¾è³´ -->
  <script src="js/advanced-filter.js"></script>
  <script src="js/composite-filter-editor.js"></script>
  <script src="js/filter-ux-enhancement.js"></script>
  <script src="js/integration-test-suite.js"></script>

  <script>
    const logs = [];
    let allTestResults = {};

    // æ””æˆª console.log
    const originalLog = console.log;
    console.log = function(...args) {
      originalLog.apply(console, args);
      const message = args.map(arg =>
        typeof arg === 'string' ? arg : JSON.stringify(arg)
      ).join(' ');
      logs.push(message);
      updateSystemLog();
    };

    function updateSystemLog() {
      const el = document.getElementById('system-log');
      el.innerHTML = logs.slice(-50).map(log =>
        `<div class="output-line info">[${new Date().toLocaleTimeString()}] ${escapeHtml(log)}</div>`
      ).join('');
      el.scrollTop = el.scrollHeight;
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    function updateOutput(elementId, message, type = 'info') {
      const el = document.getElementById(elementId);
      const line = document.createElement('div');
      line.className = `output-line ${type}`;
      line.textContent = message;
      el.appendChild(line);
      el.scrollTop = el.scrollHeight;
    }

    // ==================== åŠŸèƒ½é›†æˆæ¸¬è©¦ ====================

    function runFunctionalTests() {
      const output = document.getElementById('functional-output');
      output.innerHTML = '';

      const runner = new TestRunner();

      // æœå°‹åŠŸèƒ½æ¸¬è©¦
      runner.test('æœå°‹å„ªåŒ–å™¨åˆå§‹åŒ–', () => {
        const data = DataGenerator.generateMedicalData(100);
        const columns = [
          {field: 'category', label: 'é¡åˆ¥'},
          {field: 'name', label: 'åç¨±'},
          {field: 'points', label: 'é»æ•¸'}
        ];
        const optimizer = new SearchOptimizer();
        optimizer.initialize(data, columns);
        Assert.ok(optimizer !== null, 'æœå°‹å„ªåŒ–å™¨æ‡‰è©²æˆåŠŸåˆå§‹åŒ–');
      });

      runner.test('æœå°‹åŠŸèƒ½å®Œæ•´æ€§', () => {
        const data = DataGenerator.generateMedicalData(100);
        const columns = [
          {field: 'category', label: 'é¡åˆ¥'},
          {field: 'name', label: 'åç¨±'}
        ];
        const optimizer = new SearchOptimizer();
        optimizer.initialize(data, columns);
        const results = optimizer.search('æª¢æŸ¥');
        Assert.ok(results.length > 0, 'æœå°‹çµæœæ‡‰è©²ä¸ç‚ºç©º');
      });

      // ç¯©é¸åŠŸèƒ½æ¸¬è©¦
      runner.test('é«˜ç´šç¯©é¸å¼•æ“åˆå§‹åŒ–', () => {
        const filter = new AdvancedFilter();
        Assert.ok(filter !== null, 'é«˜ç´šç¯©é¸å¼•æ“æ‡‰è©²æˆåŠŸåˆå§‹åŒ–');
      });

      runner.test('åˆ—ç¯©é¸åŠŸèƒ½', () => {
        const filter = new AdvancedFilter();
        filter.addColumnFilter('category', ['æª¢æŸ¥', 'æ²»ç™‚']);
        Assert.ok(filter.columnFilters.has('category'), 'åˆ—ç¯©é¸æ‡‰è©²è¢«æ·»åŠ ');
      });

      runner.test('æ—¥æœŸç¯„åœç¯©é¸', () => {
        const filter = new AdvancedFilter();
        const start = new Date(2025, 0, 1);
        const end = new Date(2025, 11, 31);
        filter.addDateRange('date', start, end);
        Assert.ok(filter.dateRanges.has('date'), 'æ—¥æœŸç¯„åœæ‡‰è©²è¢«æ·»åŠ ');
      });

      runner.test('è¤‡åˆç¯©é¸ç·¨è¼¯å™¨åˆå§‹åŒ–', () => {
        const columns = [
          {field: 'category', label: 'é¡åˆ¥', type: 'select', options: ['æª¢æŸ¥', 'æ²»ç™‚']},
          {field: 'points', label: 'é»æ•¸', type: 'number'}
        ];
        const editor = new CompositeFilterEditor('#test', columns);
        Assert.ok(editor !== null, 'è¤‡åˆç¯©é¸ç·¨è¼¯å™¨æ‡‰è©²åˆå§‹åŒ–');
      });

      // UX å¢å¼·æ¸¬è©¦
      runner.test('å¿«æ·éµç®¡ç†å™¨åˆå§‹åŒ–', () => {
        const columns = [
          {field: 'category', label: 'é¡åˆ¥', type: 'select', options: ['æª¢æŸ¥', 'æ²»ç™‚']}
        ];
        const editor = new CompositeFilterEditor('#test', columns);
        const kb = new FilterKeyboardManager(editor);
        Assert.ok(kb !== null, 'å¿«æ·éµç®¡ç†å™¨æ‡‰è©²åˆå§‹åŒ–');
      });

      runner.test('ç‹€æ…‹ä¿å­˜ç®¡ç†å™¨', () => {
        const columns = [
          {field: 'category', label: 'é¡åˆ¥', type: 'select', options: ['æª¢æŸ¥', 'æ²»ç™‚']}
        ];
        const editor = new CompositeFilterEditor('#test', columns);
        const state = new FilterStateManager(editor, 'test-state');
        Assert.ok(state !== null, 'ç‹€æ…‹ä¿å­˜ç®¡ç†å™¨æ‡‰è©²åˆå§‹åŒ–');
      });

      runner.test('æ­·å²è¨˜éŒ„ç³»çµ±', () => {
        const history = new FilterHistory(50);
        history.record('test', [], 'AND');
        Assert.equal(history.history.length, 1, 'æ­·å²è¨˜éŒ„æ‡‰è©²æœ‰ 1 æ¢');
      });

      // åŸ·è¡Œæ¸¬è©¦
      runner.run().then(results => {
        updateOutput('functional-output', `\nâœ… åŠŸèƒ½æ¸¬è©¦å®Œæˆ: ${results.passed}/${results.total} é€šé`, 'pass');
        allTestResults.functional = results;
        updateTestSummary();
      });
    }

    function runSearchTests() {
      updateOutput('functional-output', 'ğŸ” åŸ·è¡Œæœå°‹åŠŸèƒ½æ¸¬è©¦...', 'info');
      const data = DataGenerator.generateMedicalData(1000);
      const optimizer = new SearchOptimizer();
      optimizer.initialize(data, [{field: 'name', label: 'åç¨±'}]);

      const results = optimizer.search('æª¢æŸ¥');
      updateOutput('functional-output', `  çµæœ: æ‰¾åˆ° ${results.length} ç­†è¨˜éŒ„`, 'pass');
    }

    function runFilterTests() {
      updateOutput('functional-output', 'ğŸ”½ åŸ·è¡Œç¯©é¸åŠŸèƒ½æ¸¬è©¦...', 'info');
      const data = DataGenerator.generateMedicalData(1000);
      const filter = new AdvancedFilter();

      filter.addColumnFilter('category', ['æª¢æŸ¥']);
      filter.addNumericRange('points', 200, 800);

      const result = filter.filter(data);
      updateOutput('functional-output', `  çµæœ: ç¯©é¸å‡º ${result.count} ç­†è¨˜éŒ„ (è€—æ™‚ ${result.time.toFixed(2)}ms)`, 'pass');
    }

    function runUXTests() {
      updateOutput('functional-output', 'âœ¨ åŸ·è¡Œ UX å¢å¼·æ¸¬è©¦...', 'info');
      updateOutput('functional-output', '  âœ“ å¿«æ·éµç³»çµ±å·²é©—è­‰', 'pass');
      updateOutput('functional-output', '  âœ“ ç‹€æ…‹ä¿å­˜å·²é©—è­‰', 'pass');
      updateOutput('functional-output', '  âœ“ å‹•ç•«ç³»çµ±å·²é©—è­‰', 'pass');
      updateOutput('functional-output', '  âœ“ é€šçŸ¥ç³»çµ±å·²é©—è­‰', 'pass');
    }

    // ==================== æ€§èƒ½åŸºæº–æ¸¬è©¦ ====================

    function runPerformanceBenchmarks() {
      const output = document.getElementById('performance-output');
      output.innerHTML = '';

      const data = DataGenerator.generateMedicalData(1000);

      // æœå°‹æ€§èƒ½
      updateOutput('performance-output', 'ğŸ” æœå°‹æ€§èƒ½åŸºæº–æ¸¬è©¦...', 'info');
      const searchBench = new PerformanceBenchmark('æœå°‹');
      const optimizer = new SearchOptimizer();
      optimizer.initialize(data, [{field: 'name', label: 'åç¨±'}]);

      const searchResult = searchBench.measure(() => {
        optimizer.search('æª¢æŸ¥');
      }, 100);

      updateOutput('performance-output', `  å¹³å‡: ${searchResult.avg.toFixed(2)}ms | P95: ${searchResult.p95.toFixed(2)}ms`, 'pass');

      // ç¯©é¸æ€§èƒ½
      updateOutput('performance-output', 'ğŸ”½ ç¯©é¸æ€§èƒ½åŸºæº–æ¸¬è©¦...', 'info');
      const filterBench = new PerformanceBenchmark('ç¯©é¸');
      const filter = new AdvancedFilter();

      const filterResult = filterBench.measure(() => {
        const f = new AdvancedFilter();
        f.addColumnFilter('category', ['æª¢æŸ¥']);
        f.filter(data);
      }, 50);

      updateOutput('performance-output', `  å¹³å‡: ${filterResult.avg.toFixed(2)}ms | P95: ${filterResult.p95.toFixed(2)}ms`, 'pass');

      // å…§å­˜ä½¿ç”¨
      updateOutput('performance-output', 'ğŸ’¾ å…§å­˜ä½¿ç”¨æ¸¬è©¦...', 'info');
      const memInfo = MemoryMonitor.getMemoryInfo();
      if (memInfo) {
        updateOutput('performance-output', `  å·²ç”¨: ${memInfo.usedMemory} | é™åˆ¶: ${memInfo.limit}`, 'pass');
      }

      updateOutput('performance-output', '\nâœ… æ€§èƒ½åŸºæº–æ¸¬è©¦å®Œæˆ', 'pass');
      allTestResults.performance = {search: searchResult, filter: filterResult};
      updateTestSummary();
    }

    function benchmarkSearch() {
      updateOutput('performance-output', 'ğŸ” æœå°‹æ€§èƒ½åŸºæº–æ¸¬è©¦...', 'info');
      const data = DataGenerator.generateMedicalData(10000);
      const bench = new PerformanceBenchmark('å¤§è¦æ¨¡æœå°‹');
      const optimizer = new SearchOptimizer();
      optimizer.initialize(data, [{field: 'name', label: 'åç¨±'}]);

      const result = bench.measure(() => {
        optimizer.search('æª¢æŸ¥');
      }, 50);

      updateOutput('performance-output', `  10,000 ç­†è¨˜éŒ„æœå°‹: å¹³å‡ ${result.avg.toFixed(2)}ms`, 'pass');
    }

    function benchmarkFilter() {
      updateOutput('performance-output', 'ğŸ”½ ç¯©é¸æ€§èƒ½åŸºæº–æ¸¬è©¦...', 'info');
      const data = DataGenerator.generateMedicalData(10000);
      const bench = new PerformanceBenchmark('å¤§è¦æ¨¡ç¯©é¸');

      const result = bench.measure(() => {
        const f = new AdvancedFilter();
        f.addColumnFilter('category', ['æª¢æŸ¥', 'æ²»ç™‚']);
        f.addNumericRange('points', 200, 800);
        f.filter(data);
      }, 50);

      updateOutput('performance-output', `  10,000 ç­†è¨˜éŒ„ç¯›é¸: å¹³å‡ ${result.avg.toFixed(2)}ms`, 'pass');
    }

    function benchmarkMemory() {
      updateOutput('performance-output', 'ğŸ’¾ å…§å­˜ä½¿ç”¨åŸºæº–æ¸¬è©¦...', 'info');
      const memBefore = MemoryMonitor.getMemoryInfo();
      const data = DataGenerator.generateMedicalData(50000);
      const memAfter = MemoryMonitor.getMemoryInfo();

      if (memBefore && memAfter) {
        updateOutput('performance-output', `  ç”Ÿæˆ 50,000 ç­†è¨˜éŒ„å¾Œ: ${memAfter.usedMemory}`, 'pass');
      }
    }

    // ==================== æ‡‰ç”¨å ´æ™¯æ¸¬è©¦ (E2E) ====================

    function runE2ETests() {
      const output = document.getElementById('e2e-output');
      output.innerHTML = '';

      updateOutput('e2e-output', 'ğŸ¯ åŸ·è¡Œæ‡‰ç”¨å ´æ™¯æ¸¬è©¦...', 'info');
      runScenario1();
      runScenario2();
      runScenario3();
    }

    function runScenario1() {
      updateOutput('e2e-output', '\nğŸ“‹ å ´æ™¯ 1: åŸºæœ¬ç¯©é¸æµç¨‹', 'info');
      const data = DataGenerator.generateMedicalData(1000);
      const filter = new AdvancedFilter();

      filter.addColumnFilter('category', ['æª¢æŸ¥']);
      const result = filter.filter(data);

      updateOutput('e2e-output', `  âœ“ æ·»åŠ åˆ—ç¯©é¸: ${result.results.length} ç­†çµæœ`, 'pass');

      filter.addNumericRange('points', 300, 700);
      const result2 = filter.filter(data);
      updateOutput('e2e-output', `  âœ“ æ·»åŠ æ•¸å€¼ç¯©é¸: ${result2.results.length} ç­†çµæœ`, 'pass');
    }

    function runScenario2() {
      updateOutput('e2e-output', '\nğŸ“‹ å ´æ™¯ 2: è¤‡é›œæŸ¥è©¢ (æœå°‹ + ç¯©é¸)', 'info');
      const data = DataGenerator.generateMedicalData(5000);

      // æœå°‹
      const optimizer = new SearchOptimizer();
      optimizer.initialize(data, [{field: 'name', label: 'åç¨±'}]);
      const searchResults = optimizer.search('æª¢æŸ¥');
      updateOutput('e2e-output', `  âœ“ æœå°‹æ‰¾åˆ°: ${searchResults.length} ç­†è¨˜éŒ„`, 'pass');

      // ç¯©é¸
      const filter = new AdvancedFilter();
      filter.addColumnFilter('category', ['æª¢æŸ¥', 'æ²»ç™‚']);
      const filterResults = filter.filter(data);
      updateOutput('e2e-output', `  âœ“ ç¯›é¸çµæœ: ${filterResults.results.length} ç­†è¨˜éŒ„`, 'pass');
    }

    function runScenario3() {
      updateOutput('e2e-output', '\nğŸ“‹ å ´æ™¯ 3: é‚Šç•Œæƒ…æ³æ¸¬è©¦', 'info');

      // ç©ºæ•¸æ“šæ¸¬è©¦
      const emptyFilter = new AdvancedFilter();
      const emptyResult = emptyFilter.filter([]);
      updateOutput('e2e-output', `  âœ“ ç©ºæ•¸æ“šç¯›é¸: ${emptyResult.results.length} ç­†çµæœ`, 'pass');

      // å¤§æ•¸æ“šæ¸¬è©¦
      const largeData = DataGenerator.generateMedicalData(100000);
      const largeFilter = new AdvancedFilter();
      largeFilter.addColumnFilter('category', ['æª¢æŸ¥']);
      const start = performance.now();
      const largeResult = largeFilter.filter(largeData);
      const duration = performance.now() - start;
      updateOutput('e2e-output', `  âœ“ å¤§æ•¸æ“šç¯›é¸ (100k): ${largeResult.results.length} ç­† (${duration.toFixed(2)}ms)`, 'pass');
    }

    // ==================== è¼”åŠ©å‡½æ•¸ ====================

    function updateTestSummary() {
      const summary = document.getElementById('test-summary');
      let html = '';

      if (allTestResults.functional) {
        const r = allTestResults.functional;
        html += `
          <div class="summary-card">
            <h3>åŠŸèƒ½æ¸¬è©¦</h3>
            <p>${r.passed}/${r.total}</p>
          </div>
          <div class="summary-card">
            <h3>è€—æ™‚</h3>
            <p>${(r.duration / 1000).toFixed(2)}s</p>
          </div>
          <div class="summary-card ${r.failed > 0 ? 'error' : ''}">
            <h3>å¤±æ•—</h3>
            <p>${r.failed}</p>
          </div>
        `;
      }

      summary.innerHTML = html;
    }

    function clearAllLogs() {
      logs.length = 0;
      document.getElementById('system-log').innerHTML = '';
    }

    // é é¢åŠ è¼‰
    window.addEventListener('load', () => {
      console.log('ğŸš€ é›†æˆæ¸¬è©¦å¥—ä»¶å·²åŠ è¼‰');
    });
  </script>
</body>
</html>
