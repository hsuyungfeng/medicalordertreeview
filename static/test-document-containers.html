<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æ–‡æª”å®¹å™¨æ¸¬è©¦</title>
  <link rel="stylesheet" href="css/medical-tree.css">
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
      background: #f5f5f5;
    }
    .test-section {
      background: white;
      padding: 20px;
      margin: 20px 0;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    .test-section h2 {
      border-bottom: 2px solid #667eea;
      padding-bottom: 10px;
      margin-top: 0;
    }
    .status {
      padding: 10px;
      margin: 10px 0;
      border-radius: 4px;
      font-weight: bold;
    }
    .status.pass { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
    .status.fail { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
    .status.warn { background: #fff3cd; color: #856404; border: 1px solid #ffeaa7; }
    #tree { max-width: 600px; }
    .tree-node { margin: 5px 0; }
    code {
      background: #f4f4f4;
      padding: 2px 6px;
      border-radius: 3px;
      font-family: 'Courier New', monospace;
    }
    .debug-log {
      background: #f9f9f9;
      border: 1px solid #ddd;
      border-radius: 4px;
      padding: 10px;
      max-height: 200px;
      overflow-y: auto;
      font-size: 12px;
      font-family: monospace;
      margin-top: 10px;
    }
    .debug-log > div {
      padding: 2px 0;
    }
    .log-info { color: #2196F3; }
    .log-warn { color: #FF9800; }
    .log-error { color: #F44336; }
    .log-success { color: #4CAF50; }
  </style>
</head>
<body>
  <h1>ğŸ§ª æ–‡æª”å®¹å™¨å¯¦ç¾æ¸¬è©¦</h1>

  <div class="test-section">
    <h2>1ï¸âƒ£ ç’°å¢ƒæª¢æŸ¥</h2>
    <div id="env-checks"></div>
  </div>

  <div class="test-section">
    <h2>2ï¸âƒ£ DOM çµæ§‹æª¢æŸ¥</h2>
    <div id="dom-tree"></div>
  </div>

  <div class="test-section">
    <h2>3ï¸âƒ£ æ¨¹ç‹€ç¯€é»æ¸¬è©¦</h2>
    <div id="tree" style="border: 1px solid #ddd; padding: 10px; background: white; max-height: 400px; overflow-y: auto;"></div>
    <div id="debug-log" class="debug-log"></div>
  </div>

  <div class="test-section">
    <h2>4ï¸âƒ£ äº‹ä»¶ç¶å®šæª¢æŸ¥</h2>
    <div id="event-checks"></div>
  </div>

  <!-- ä¾è³´çš„æ¨¡å¡Š -->
  <script src="js/document-content-extractor.js"></script>
  <script src="js/tree-loader.js"></script>

  <script>
    // ========================================
    // 1. ç’°å¢ƒæª¢æŸ¥
    // ========================================
    function checkEnvironment() {
      const checks = document.getElementById('env-checks');
      const results = [];

      // æª¢æŸ¥ DocumentContentExtractor
      const hasExtractor = !!window.DocumentContentExtractor;
      results.push({
        name: 'DocumentContentExtractor',
        pass: hasExtractor,
        message: hasExtractor ? 'âœ“ å·²åŠ è¼‰' : 'âœ— æœªåŠ è¼‰'
      });

      // æª¢æŸ¥ LazyTreeLoader
      const hasTreeLoader = !!window.LazyTreeLoader;
      results.push({
        name: 'LazyTreeLoader',
        pass: hasTreeLoader,
        message: hasTreeLoader ? 'âœ“ å·²åŠ è¼‰' : 'âœ— æœªåŠ è¼‰'
      });

      // æª¢æŸ¥ CSS æ¨£å¼
      const style = document.createElement('div');
      style.className = 'tree-node-document';
      document.body.appendChild(style);
      const computed = window.getComputedStyle(style);
      const hasCSSStyles = computed.maxHeight === '0px' && computed.opacity === '0';
      document.body.removeChild(style);

      results.push({
        name: 'CSS æ¨£å¼ (.tree-node-document)',
        pass: hasCSSStyles,
        message: hasCSSStyles ?
          `âœ“ æ­£ç¢º (max-height: ${computed.maxHeight}, opacity: ${computed.opacity})` :
          `âœ— ä¸æ­£ç¢º (max-height: ${computed.maxHeight}, opacity: ${computed.opacity})`
      });

      // æ¸²æŸ“çµæœ
      checks.innerHTML = results.map(r => `
        <div class="status ${r.pass ? 'pass' : 'fail'}">
          ${r.name}: ${r.message}
        </div>
      `).join('');

      return results.every(r => r.pass);
    }

    // ========================================
    // 2. æ¸¬è©¦ç¯€é»å‰µå»º
    // ========================================
    let logMessages = [];

    function addLog(type, message) {
      const timestamp = new Date().toLocaleTimeString();
      logMessages.push({ type, message, timestamp });
      updateDebugLog();
    }

    function updateDebugLog() {
      const logDiv = document.getElementById('debug-log');
      logDiv.innerHTML = logMessages.map(log => `
        <div class="log-${log.type}">[${log.timestamp}] ${log.message}</div>
      `).join('');
      logDiv.scrollTop = logDiv.scrollHeight;
    }

    function testTreeLoader() {
      if (!window.LazyTreeLoader) {
        document.getElementById('tree').innerHTML = '<p style="color: red;">âŒ LazyTreeLoader æœªåŠ è¼‰</p>';
        return;
      }

      // æ””æˆª fetch ä»¥ä½¿ç”¨æ¸¬è©¦æ•¸æ“š
      const originalFetch = window.fetch;
      window.fetch = function(url) {
        if (url.includes('tree-structure.json')) {
          addLog('info', `ğŸ“¡ åŠ è¼‰: ${url}`);
          return Promise.resolve({
            ok: true,
            json: () => Promise.resolve({
              root: {
                children: [
                  {
                    id: 'test-section',
                    type: 'section',
                    label: 'æ¸¬è©¦ç¯€é»ï¼šæœ‰å…§å®¹å’Œå­ç¯€é»',
                    level: 1,
                    has_children: true,
                    content: 'é€šå‰‡ï¼š\né€™æ˜¯ä¸€å€‹æ¸¬è©¦ç¯€é»çš„æ–‡æª”å…§å®¹ã€‚\næ­¤å…§å®¹æ‡‰è©²åœ¨å·¦å´æ¨¹ç‹€çµæ§‹ä¸‹æ–¹å±•é–‹ã€‚',
                    subsections: [
                      {
                        title: 'å…§å®¹ 1',
                        content: 'ç¬¬ä¸€å€‹å­å…§å®¹ï¼šå±•é–‹æŒ‰éˆ•æ‡‰è©²å¯ä»¥é»æ“Š'
                      },
                      {
                        title: 'å…§å®¹ 2',
                        content: 'ç¬¬äºŒå€‹å­å…§å®¹ï¼šæª¢æŸ¥æ˜¯å¦æ­£ç¢ºæ¸²æŸ“'
                      }
                    ]
                  },
                  {
                    id: 'test-doc-only',
                    type: 'subsection',
                    label: 'æ¸¬è©¦ç¯€é»ï¼šåªæœ‰å…§å®¹',
                    level: 1,
                    has_children: false,
                    content: 'èªªæ˜ï¼š\né€™å€‹ç¯€é»åªæœ‰æ–‡æª”å…§å®¹ï¼Œæ²’æœ‰å­ç¯€é»ã€‚'
                  },
                  {
                    id: 'test-empty',
                    type: 'subsection',
                    label: 'æ¸¬è©¦ç¯€é»ï¼šç„¡å…§å®¹',
                    level: 1,
                    has_children: false,
                    content: ''
                  }
                ]
              }
            })
          });
        }
        return originalFetch(url);
      };

      const treeContainer = document.getElementById('tree');
      const loader = new LazyTreeLoader(treeContainer, 'data');

      // åŸå§‹çš„ console.log æœƒè¢«é‡å®šå‘åˆ°æˆ‘å€‘çš„æ—¥èªŒç³»çµ±
      const originalLog = console.log;
      console.log = function(...args) {
        const message = args.map(arg =>
          typeof arg === 'string' ? arg : JSON.stringify(arg)
        ).join(' ');
        addLog('info', message);
        originalLog.apply(console, args);
      };

      loader.init().then(() => {
        addLog('success', 'âœ“ æ¨¹ç‹€çµæ§‹å·²åŠ è¼‰');

        // æª¢æŸ¥ DOM çµæ§‹
        setTimeout(() => {
          checkDOMStructure();
          checkEventBinding();
        }, 100);
      }).catch(err => {
        addLog('error', `âœ— åŠ è¼‰å¤±æ•—: ${err.message}`);
      });
    }

    // ========================================
    // 3. æª¢æŸ¥ DOM çµæ§‹
    // ========================================
    function checkDOMStructure() {
      addLog('info', 'ğŸ” æª¢æŸ¥ DOM çµæ§‹...');

      const nodes = document.querySelectorAll('.tree-node');
      addLog('info', `ç™¼ç¾ ${nodes.length} å€‹æ¨¹ç¯€é»`);

      nodes.forEach((node, idx) => {
        const nodeId = node.getAttribute('data-node-id');
        const label = node.querySelector('.node-label')?.textContent || 'ç„¡æ¨™ç±¤';

        // æª¢æŸ¥å®¹å™¨
        const hasHeader = !!node.querySelector('.tree-node-header');
        const hasDocContainer = !!node.querySelector('.tree-node-document');
        const hasChildrenContainer = !!node.querySelector('.tree-node-children');
        const hasDocIcon = !!node.querySelector('.document-icon');
        const hasToggleIcon = !!node.querySelector('.toggle-icon');

        addLog('info', `
          ç¯€é» #${idx+1}: ${label}
          â”œâ”€ Header: ${hasHeader ? 'âœ“' : 'âœ—'}
          â”œâ”€ Document å®¹å™¨: ${hasDocContainer ? 'âœ“' : 'âœ—'}
          â”œâ”€ Children å®¹å™¨: ${hasChildrenContainer ? 'âœ“' : 'âœ—'}
          â”œâ”€ Document åœ–æ¨™: ${hasDocIcon ? 'âœ“' : 'âœ—'}
          â””â”€ Toggle åœ–æ¨™: ${hasToggleIcon ? 'âœ“' : 'âœ—'}
        `);
      });
    }

    // ========================================
    // 4. æª¢æŸ¥äº‹ä»¶ç¶å®š
    // ========================================
    function checkEventBinding() {
      addLog('info', 'ğŸ”— æª¢æŸ¥äº‹ä»¶ç¶å®š...');

      const documentIcons = document.querySelectorAll('.document-icon');
      addLog('info', `ç™¼ç¾ ${documentIcons.length} å€‹ document åœ–æ¨™`);

      documentIcons.forEach((icon, idx) => {
        const hasListener = getEventListeners?.(icon)?.click?.length > 0;
        addLog('warn', `Document åœ–æ¨™ #${idx+1}: ${hasListener ? 'âœ“ å·²ç¶å®šäº‹ä»¶' : '? ç„¡æ³•ç¢ºèªäº‹ä»¶ç¶å®š'}`);
      });

      // æ¸¬è©¦é»æ“Šäº‹ä»¶
      const firstIcon = document.querySelector('.document-icon');
      if (firstIcon) {
        addLog('info', 'âœ“ æº–å‚™æ¸¬è©¦é»æ“Šäº‹ä»¶ï¼Œè«‹é»æ“Šä»»ä½•ä¸€å€‹ ğŸ“– åœ–æ¨™...');

        // ç¶å®šè‡¨æ™‚ç›£è½å™¨
        document.addEventListener('click', (e) => {
          if (e.target.classList?.contains('document-icon')) {
            addLog('success', `âœ“ å·²åµæ¸¬åˆ° document-icon é»æ“Šäº‹ä»¶!`);
          }
        });
      }
    }

    // ========================================
    // 5. é é¢åˆå§‹åŒ–
    // ========================================
    window.addEventListener('load', () => {
      addLog('info', 'ğŸš€ æ¸¬è©¦é–‹å§‹...');

      const envOk = checkEnvironment();

      if (envOk) {
        testTreeLoader();
      } else {
        addLog('error', 'âŒ ç’°å¢ƒæª¢æŸ¥å¤±æ•—ï¼Œç„¡æ³•ç¹¼çºŒæ¸¬è©¦');
      }
    });

    // ç›£æ§å…¨å±€ console è¼¸å‡º
    const originalConsoleWarn = console.warn;
    const originalConsoleError = console.error;

    console.warn = function(...args) {
      const message = args.join(' ');
      addLog('warn', message);
      originalConsoleWarn.apply(console, args);
    };

    console.error = function(...args) {
      const message = args.join(' ');
      addLog('error', message);
      originalConsoleError.apply(console, args);
    };
  </script>
</body>
</html>
