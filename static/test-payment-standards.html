<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æ”¯ä»˜æ¨™æº–è¡¨æ¸¬è©¦</title>
  <link rel="stylesheet" href="css/medical-tree.css">
  <style>
    body {
      padding: 20px;
      background: #f5f5f5;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
    }
    .test-container {
      max-width: 1400px;
      margin: 0 auto;
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    .test-section {
      margin-bottom: 30px;
      border: 1px solid #e0e0e0;
      padding: 15px;
      border-radius: 6px;
    }
    .test-section h3 {
      margin-top: 0;
      color: #333;
      border-bottom: 2px solid #667eea;
      padding-bottom: 10px;
    }
    .test-result {
      padding: 10px;
      margin: 10px 0;
      border-radius: 4px;
      background: #f0f4ff;
      border-left: 4px solid #667eea;
      font-size: 14px;
    }
    .test-result.success {
      background: #e8f5e9;
      border-left-color: #4caf50;
    }
    .test-result.error {
      background: #ffebee;
      border-left-color: #f44336;
    }
    .test-result.warning {
      background: #fff3e0;
      border-left-color: #ff9800;
    }
    .test-result strong {
      display: block;
      margin-bottom: 5px;
    }
    .test-result small {
      color: #666;
      display: block;
    }
    .demo-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 15px;
      font-size: 13px;
    }
    .demo-table th {
      background: #667eea;
      color: white;
      padding: 8px;
      text-align: left;
      font-weight: 600;
    }
    .demo-table td {
      padding: 8px;
      border-bottom: 1px solid #e0e0e0;
    }
    .demo-table tr:hover {
      background: #f5f5f5;
    }
    .stats {
      background: #f5f5f5;
      padding: 10px;
      border-radius: 4px;
      margin-top: 10px;
      font-family: monospace;
      font-size: 12px;
    }
    .data-section {
      background: #fafbfc;
      padding: 15px;
      border-radius: 6px;
      margin-top: 15px;
    }
    .summary {
      margin-top: 20px;
      padding: 15px;
      background: #e8f5e9;
      border: 2px solid #4caf50;
      border-radius: 6px;
    }
    .summary h3 {
      margin: 0 0 10px 0;
      color: #2e7d32;
      border: none;
      padding: 0;
    }
    .code-block {
      background: #f5f5f5;
      padding: 10px;
      border-radius: 4px;
      overflow-x: auto;
      font-family: monospace;
      font-size: 12px;
      margin-top: 10px;
    }
  </style>
</head>
<body>
  <div class="test-container">
    <h1>ğŸ’° æ”¯ä»˜æ¨™æº–è¡¨æ¸¬è©¦</h1>
    <p>é©—è­‰æ”¯ä»˜æ¨™æº–è¡¨å¯¦ç¾çš„å®Œæ•´æ€§å’Œæ­£ç¢ºæ€§</p>

    <div id="results"></div>

    <!-- æ¼”ç¤ºå€åŸŸ -->
    <div class="test-section">
      <h3>ğŸ“Š æ”¯ä»˜æ¨™æº–è¡¨æ¼”ç¤º</h3>
      <div id="demo"></div>
    </div>

    <!-- æ—¥æœŸæ ¼å¼æ¸¬è©¦ -->
    <div class="test-section">
      <h3>ğŸ“… æ—¥æœŸæ ¼å¼åŒ–æ¸¬è©¦</h3>
      <div id="date-tests"></div>
    </div>

    <!-- è¡¨æ ¼æ˜ å°„é©—è­‰ -->
    <div class="test-section">
      <h3>ğŸ—ºï¸ è¡¨æ ¼æ˜ å°„é©—è­‰</h3>
      <div id="mapping-tests"></div>
    </div>
  </div>

  <script src="js/table-renderer.js"></script>
  <script src="js/table-loader.js"></script>
  <script>
    const results = [];

    function logTest(name, success, details) {
      results.push({ name, success, details });
      const resultDiv = document.getElementById('results');
      const testDiv = document.createElement('div');
      testDiv.className = `test-result ${success ? 'success' : 'error'}`;
      testDiv.innerHTML = `<strong>${success ? 'âœ“' : 'âœ—'} ${name}</strong><small>${details}</small>`;
      resultDiv.appendChild(testDiv);
    }

    // ============ æ¸¬è©¦ 1-5: StandardTableAdapter åŸºç¤åŠŸèƒ½ ============

    // æ¸¬è©¦ 1: StandardTableAdapter åˆå§‹åŒ–
    try {
      const adapter = new StandardTableAdapter();
      logTest('StandardTableAdapter åˆå§‹åŒ–', !!adapter, 'æˆåŠŸå‰µå»ºå¯¦ä¾‹');
    } catch (e) {
      logTest('StandardTableAdapter åˆå§‹åŒ–', false, `éŒ¯èª¤: ${e.message}`);
    }

    // æ¸¬è©¦ 2: ç²å–åˆ—å®šç¾©
    try {
      const adapter = new StandardTableAdapter();
      const columns = adapter.getColumns();
      const hasRequiredColumns =
        columns.some(c => c.key === 'code') &&
        columns.some(c => c.key === 'name') &&
        columns.some(c => c.key === 'payment_points') &&
        columns.some(c => c.key === 'effective_from') &&
        columns.some(c => c.key === 'effective_to');
      logTest('åˆ—å®šç¾©å®Œæ•´', hasRequiredColumns, `å®šç¾©äº† ${columns.length} åˆ—`);
    } catch (e) {
      logTest('åˆ—å®šç¾©å®Œæ•´', false, `éŒ¯èª¤: ${e.message}`);
    }

    // æ¸¬è©¦ 3: è¡Œæ•¸æ“šæ ¼å¼åŒ–
    try {
      const adapter = new StandardTableAdapter();
      const row = {
        code: '01024C',
        name: 'å±±åœ°é›¢å³¶åœ°å€é†«ç™‚å ±é…¬',
        payment_points: 1090,
        effective_from: '20160401',
        effective_to: '29101231'
      };
      const formatted = adapter.formatRow(row);
      const hasAllFields = formatted.code && formatted.name &&
                          formatted.payment_points && formatted.effective_from &&
                          formatted.effective_to;
      logTest('è¡Œæ•¸æ“šæ ¼å¼åŒ–', hasAllFields, `æˆåŠŸæ ¼å¼åŒ– ${Object.keys(formatted).length} å€‹å­—æ®µ`);
    } catch (e) {
      logTest('è¡Œæ•¸æ“šæ ¼å¼åŒ–', false, `éŒ¯èª¤: ${e.message}`);
    }

    // æ¸¬è©¦ 4: æ—¥æœŸæ ¼å¼åŒ–æ–¹æ³•
    try {
      const adapter = new StandardTableAdapter();
      const dateStr = '20160401';
      const formatted = adapter.formatDate(dateStr);
      const isCorrect = formatted === '2016-04-01';
      logTest('æ—¥æœŸæ ¼å¼åŒ–', isCorrect, `${dateStr} â†’ ${formatted}`);
    } catch (e) {
      logTest('æ—¥æœŸæ ¼å¼åŒ–', false, `éŒ¯èª¤: ${e.message}`);
    }

    // æ¸¬è©¦ 5: æ’åºå€¼æå–
    try {
      const adapter = new StandardTableAdapter();
      const row = { payment_points: '1500', code: 'TEST' };
      const sortValue = adapter.getSortValue(row, 'payment_points');
      const isNumeric = typeof sortValue === 'number' && sortValue === 1500;
      logTest('æ’åºå€¼æå–', isNumeric, `payment_points: 1500 (${typeof sortValue})`);
    } catch (e) {
      logTest('æ’åºå€¼æå–', false, `éŒ¯èª¤: ${e.message}`);
    }

    // ============ æ¸¬è©¦ 6-8: è¡¨æ ¼æ¸²æŸ“ ============

    // æ¸¬è©¦ 6: TableRenderer åˆå§‹åŒ–
    try {
      const container = document.createElement('div');
      container.className = 'table-container';
      container.innerHTML = `
        <div class="data-table">
          <table><thead><tr><th>æ¸¬è©¦</th></tr></thead><tbody></tbody></table>
        </div>
      `;
      document.body.appendChild(container);

      const renderer = new TableRenderer('.table-container', new StandardTableAdapter());
      document.body.removeChild(container);
      logTest('è¡¨æ ¼æ¸²æŸ“å™¨åˆå§‹åŒ–', true, 'æˆåŠŸå‰µå»ºè¡¨æ ¼æ¸²æŸ“å™¨');
    } catch (e) {
      logTest('è¡¨æ ¼æ¸²æŸ“å™¨åˆå§‹åŒ–', false, `éŒ¯èª¤: ${e.message}`);
    }

    // æ¸¬è©¦ 7: è¨­ç½®è¡¨æ ¼æ•¸æ“š
    try {
      const container = document.createElement('div');
      container.className = 'table-container';
      container.innerHTML = `
        <div class="data-table">
          <table><thead></thead><tbody></tbody></table>
        </div>
      `;
      document.body.appendChild(container);

      const renderer = new TableRenderer('.table-container', new StandardTableAdapter());
      const testData = [
        { code: '01001C', name: 'åˆè¨ºè²»', payment_points: 500, effective_from: '20160401', effective_to: '29101231' },
        { code: '01002C', name: 'è¤‡è¨ºè²»', payment_points: 300, effective_from: '20160401', effective_to: '29101231' }
      ];
      renderer.setData(testData);

      document.body.removeChild(container);
      logTest('è¨­ç½®è¡¨æ ¼æ•¸æ“š', renderer.data.length === 2, `å·²åŠ è¼‰ ${renderer.data.length} ç­†æ•¸æ“š`);
    } catch (e) {
      logTest('è¨­ç½®è¡¨æ ¼æ•¸æ“š', false, `éŒ¯èª¤: ${e.message}`);
    }

    // æ¸¬è©¦ 8: è¡¨æ ¼æ’åº
    try {
      const adapter = new StandardTableAdapter();
      const data = [
        { code: '01003C', name: 'C', payment_points: 300 },
        { code: '01001C', name: 'A', payment_points: 100 },
        { code: '01002C', name: 'B', payment_points: 200 }
      ];

      // æ¸¬è©¦æ’åºèƒ½åŠ›
      const canSortCode = adapter.canSort('code');
      const canSortPoints = adapter.canSort('payment_points');
      const success = canSortCode && canSortPoints;
      logTest('æ’åºèƒ½åŠ›', success, `ä»£ç¢¼å¯æ’åº: ${canSortCode}, é»æ•¸å¯æ’åº: ${canSortPoints}`);
    } catch (e) {
      logTest('æ’åºèƒ½åŠ›', false, `éŒ¯èª¤: ${e.message}`);
    }

    // ============ æ—¥æœŸæ ¼å¼åŒ–è©³ç´°æ¸¬è©¦ ============
    const dateTestsContainer = document.getElementById('date-tests');
    const dateTestCases = [
      { input: '20160401', expected: '2016-04-01', description: 'æ¨™æº–æ—¥æœŸ' },
      { input: '20250901', expected: '2025-09-01', description: '2025å¹´æ—¥æœŸ' },
      { input: '29101231', expected: '2910-12-31', description: 'æ¥µé™æ—¥æœŸ' },
      { input: '', expected: '', description: 'ç©ºå­—ç¬¦ä¸²' },
      { input: '2016-04-01', expected: '2016-04-01', description: 'å·²æ ¼å¼åŒ–æ—¥æœŸ' }
    ];

    dateTestCases.forEach((testCase, index) => {
      try {
        const adapter = new StandardTableAdapter();
        const result = adapter.formatDate(testCase.input);
        const success = result === testCase.expected;
        const testDiv = document.createElement('div');
        testDiv.className = `test-result ${success ? 'success' : 'warning'}`;
        testDiv.innerHTML = `
          <strong>æ—¥æœŸæ¸¬è©¦ ${index + 1}: ${testCase.description}</strong>
          <small>è¼¸å…¥: "${testCase.input}" â†’ è¼¸å‡º: "${result}" (é æœŸ: "${testCase.expected}")</small>
        `;
        dateTestsContainer.appendChild(testDiv);
      } catch (e) {
        const testDiv = document.createElement('div');
        testDiv.className = 'test-result error';
        testDiv.innerHTML = `<strong>æ—¥æœŸæ¸¬è©¦ ${index + 1} å¤±æ•—</strong><small>${e.message}</small>`;
        dateTestsContainer.appendChild(testDiv);
      }
    });

    // ============ è¡¨æ ¼æ˜ å°„é©—è­‰ ============
    const mappingTestsContainer = document.getElementById('mapping-tests');

    // æ¸¬è©¦ 9: åŠ è¼‰è¡¨æ ¼æ˜ å°„
    fetch('data/table-mapping.json')
      .then(response => response.json())
      .then(mapping => {
        try {
          const hasMappings = mapping.mappings && Object.keys(mapping.mappings).length > 0;
          const allHaveStandardTable = Object.values(mapping.mappings).every(section =>
            section.tables && section.tables.some(t => t.type === 'standard')
          );

          const testDiv = document.createElement('div');
          testDiv.className = `test-result ${allHaveStandardTable ? 'success' : 'warning'}`;
          testDiv.innerHTML = `
            <strong>âœ“ è¡¨æ ¼æ˜ å°„æ–‡ä»¶åŠ è¼‰æˆåŠŸ</strong>
            <small>
              ç¸½ç¯€é»æ•¸: ${Object.keys(mapping.mappings).length}<br>
              æ‰€æœ‰ç¯€é»éƒ½æœ‰æ”¯ä»˜æ¨™æº–è¡¨: ${allHaveStandardTable ? 'æ˜¯' : 'å¦'}
            </small>
          `;
          mappingTestsContainer.appendChild(testDiv);

          // è©³ç´°åˆ—å‡ºæ¯å€‹ç¯€é»çš„æ˜ å°„
          const detailDiv = document.createElement('div');
          detailDiv.className = 'data-section';
          detailDiv.innerHTML = '<h4>ç¯€é»æ˜ å°„è©³æƒ…</h4>';

          const table = document.createElement('table');
          table.className = 'demo-table';
          table.innerHTML = '<thead><tr><th>ç¯€é» ID</th><th>ç¯€é»åç¨±</th><th>CSV è¡¨</th><th>æ”¯ä»˜æ¨™æº–è¡¨</th></tr></thead><tbody></tbody>';

          Object.entries(mapping.mappings).forEach(([nodeId, section]) => {
            const csvTable = section.tables.find(t => t.type === 'csv');
            const standardTable = section.tables.find(t => t.type === 'standard');

            const row = table.querySelector('tbody').insertRow();
            row.innerHTML = `
              <td><code>${nodeId}</code></td>
              <td>${section.label}</td>
              <td>${csvTable ? 'âœ“' : 'âœ—'}</td>
              <td>${standardTable ? 'âœ“ ' + (standardTable.dataFile || 'N/A') : 'âœ—'}</td>
            `;
          });

          detailDiv.appendChild(table);
          mappingTestsContainer.appendChild(detailDiv);
        } catch (e) {
          const testDiv = document.createElement('div');
          testDiv.className = 'test-result error';
          testDiv.innerHTML = `<strong>âœ— æ˜ å°„é©—è­‰å¤±æ•—</strong><small>${e.message}</small>`;
          mappingTestsContainer.appendChild(testDiv);
        }
      })
      .catch(e => {
        const testDiv = document.createElement('div');
        testDiv.className = 'test-result error';
        testDiv.innerHTML = `<strong>âœ— ç„¡æ³•åŠ è¼‰è¡¨æ ¼æ˜ å°„æ–‡ä»¶</strong><small>${e.message}</small>`;
        mappingTestsContainer.appendChild(testDiv);
      });

    // ============ æ¸¬è©¦ 10: åŠ è¼‰æ”¯ä»˜æ¨™æº–æ•¸æ“š ============
    const demoContainer = document.getElementById('demo');

    Promise.all([
      fetch('data/payment-standards/section-2-2-1-standards.json').then(r => r.json()),
      fetch('data/payment-standards/section-2-2-2-standards.json').then(r => r.json())
    ])
      .then(([section1, section2]) => {
        try {
          const testDiv = document.createElement('div');
          testDiv.className = 'test-result success';
          testDiv.innerHTML = `
            <strong>âœ“ æ”¯ä»˜æ¨™æº–æ•¸æ“šåŠ è¼‰æˆåŠŸ</strong>
            <small>
              ç¬¬2-2-1ç¯€: ${section1.total_items} é … (å·²åŠ è¼‰ ${section1.items?.length || 0} é …)<br>
              ç¬¬2-2-2ç¯€: ${section2.total_items} é … (å·²åŠ è¼‰ ${section2.items?.length || 0} é …)
            </small>
          `;
          demoContainer.appendChild(testDiv);

          // æ¸²æŸ“æ¨£æœ¬è¡¨æ ¼
          const adapter = new StandardTableAdapter();
          const sampleDiv = document.createElement('div');
          sampleDiv.className = 'data-section';
          sampleDiv.innerHTML = '<h4>ç¬¬2-2-1ç¯€æ¨£æœ¬æ•¸æ“šï¼ˆå‰5ç­†ï¼‰</h4>';

          const table = document.createElement('table');
          table.className = 'demo-table';

          // è¡¨é ­
          const headerRow = table.insertRow();
          adapter.getColumns().forEach(col => {
            const th = document.createElement('th');
            th.textContent = col.label;
            headerRow.appendChild(th);
          });

          // æ•¸æ“šè¡Œ
          const displayData = section1.items.slice(0, 5);
          displayData.forEach(item => {
            const formatted = adapter.formatRow(item);
            const row = table.insertRow();
            adapter.getColumns().forEach(col => {
              const cell = row.insertCell();
              const value = formatted[col.key];
              cell.textContent = value || '-';
              if (col.type === 'number') {
                cell.style.textAlign = 'right';
              }
            });
          });

          sampleDiv.appendChild(table);
          demoContainer.appendChild(sampleDiv);
        } catch (e) {
          const testDiv = document.createElement('div');
          testDiv.className = 'test-result error';
          testDiv.innerHTML = `<strong>âœ— æ•¸æ“šæ¸²æŸ“å¤±æ•—</strong><small>${e.message}</small>`;
          demoContainer.appendChild(testDiv);
        }
      })
      .catch(e => {
        const testDiv = document.createElement('div');
        testDiv.className = 'test-result error';
        testDiv.innerHTML = `<strong>âœ— ç„¡æ³•åŠ è¼‰æ”¯ä»˜æ¨™æº–æ•¸æ“š</strong><small>${e.message}</small>`;
        demoContainer.appendChild(testDiv);
      });

    // ============ é¡¯ç¤ºæ¸¬è©¦æ‘˜è¦ ============
    setTimeout(() => {
      const passed = results.filter(r => r.success).length;
      const total = results.length;
      const summary = document.createElement('div');
      summary.className = 'summary';
      summary.innerHTML = `
        <h3>âœ“ æ¸¬è©¦æ‘˜è¦</h3>
        <p><strong>é€šé: ${passed}/${total}</strong></p>
        <p>æ”¯ä»˜æ¨™æº–è¡¨å¯¦ç¾å·²é©—è­‰ï¼</p>
        ${passed === total ? '<p style="color: #2e7d32;">âœ“ æ‰€æœ‰æ¸¬è©¦é€šé - æº–å‚™é€²è¡Œ Phase 3.4</p>' : ''}
      `;
      document.getElementById('results').insertBefore(summary, document.getElementById('results').firstChild);
    }, 500);
  </script>
</body>
</html>
