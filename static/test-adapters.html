<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>è¡¨æ ¼é©é…å™¨æ¸¬è©¦</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      padding: 20px;
      background: #f5f5f5;
    }
    .test-container {
      max-width: 1200px;
      margin: 0 auto;
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    .test-section {
      margin-bottom: 30px;
      border: 1px solid #e0e0e0;
      padding: 15px;
      border-radius: 6px;
    }
    .test-section h3 {
      margin-top: 0;
      color: #333;
      border-bottom: 2px solid #667eea;
      padding-bottom: 10px;
    }
    .test-result {
      padding: 10px;
      margin: 10px 0;
      border-radius: 4px;
      background: #f0f4ff;
      border-left: 4px solid #667eea;
    }
    .test-result.success {
      background: #e8f5e9;
      border-left-color: #4caf50;
    }
    .test-result.error {
      background: #ffebee;
      border-left-color: #f44336;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }
    th, td {
      border: 1px solid #ddd;
      padding: 8px;
      text-align: left;
    }
    th {
      background: #667eea;
      color: white;
    }
    tr:nth-child(even) {
      background: #f9f9f9;
    }
  </style>
</head>
<body>
  <div class="test-container">
    <h1>ğŸ§ª è¡¨æ ¼é©é…å™¨æ¸¬è©¦</h1>

    <div id="results"></div>

    <script src="js/table-renderer.js"></script>
    <script>
      const results = [];

      function logTest(name, success, details) {
        results.push({ name, success, details });
        const resultDiv = document.getElementById('results');
        const testDiv = document.createElement('div');
        testDiv.className = `test-result ${success ? 'success' : 'error'}`;
        testDiv.innerHTML = `<strong>${success ? 'âœ“' : 'âœ—'} ${name}</strong><br><small>${details}</small>`;
        resultDiv.appendChild(testDiv);
      }

      // æ¸¬è©¦ 1: CSVTableAdapter åˆå§‹åŒ–
      try {
        const csvAdapter = new CSVTableAdapter();
        logTest('CSVTableAdapter åˆå§‹åŒ–', true, 'æˆåŠŸå‰µå»º CSVTableAdapter å¯¦ä¾‹');
      } catch (e) {
        logTest('CSVTableAdapter åˆå§‹åŒ–', false, `éŒ¯èª¤: ${e.message}`);
      }

      // æ¸¬è©¦ 2: CSVTableAdapter åˆ—å®šç¾©
      try {
        const csvAdapter = new CSVTableAdapter();
        const columns = csvAdapter.getColumns();
        const success = columns.length === 5 &&
                       columns[0].key === 'code' &&
                       columns[1].key === 'name' &&
                       columns[2].key === 'points';
        logTest('CSVTableAdapter åˆ—å®šç¾©', success,
          `ç²å¾— ${columns.length} å€‹åˆ—: ${columns.map(c => c.key).join(', ')}`);
      } catch (e) {
        logTest('CSVTableAdapter åˆ—å®šç¾©', false, `éŒ¯èª¤: ${e.message}`);
      }

      // æ¸¬è©¦ 3: CSVTableAdapter è¡Œæ ¼å¼åŒ–
      try {
        const csvAdapter = new CSVTableAdapter();
        const sampleRow = {
          code: '0101',
          name: 'åˆè¨º',
          points: 200,
          effective_from: '2024-01-01',
          effective_to: '2024-12-31'
        };
        const formatted = csvAdapter.formatRow(sampleRow);
        const success = formatted.code === '0101' &&
                       formatted.name === 'åˆè¨º' &&
                       formatted.points === 200;
        logTest('CSVTableAdapter è¡Œæ ¼å¼åŒ–', success,
          `æ ¼å¼åŒ–è¡ŒæˆåŠŸ: ${JSON.stringify(formatted)}`);
      } catch (e) {
        logTest('CSVTableAdapter è¡Œæ ¼å¼åŒ–', false, `éŒ¯èª¤: ${e.message}`);
      }

      // æ¸¬è©¦ 4: CSVTableAdapter Section ç¯©é¸
      try {
        const csvAdapter = new CSVTableAdapter();
        const sampleData = [
          { code: '01001', name: 'é …ç›®1' },
          { code: '02001', name: 'é …ç›®2' },
          { code: '10001', name: 'é …ç›®3' }
        ];
        const filtered = csvAdapter.filterBySection(sampleData, 'section-2-2-1');
        const success = filtered.length === 2; // æ‡‰è©²æœ‰ code ä»¥ 01 å’Œ 02 é–‹é ­çš„
        logTest('CSVTableAdapter Section ç¯©é¸', success,
          `ç¯©é¸ section-2-2-1: å¾—åˆ° ${filtered.length} å€‹é …ç›® (æœŸæœ›: 2)`);
      } catch (e) {
        logTest('CSVTableAdapter Section ç¯©é¸', false, `éŒ¯èª¤: ${e.message}`);
      }

      // æ¸¬è©¦ 5: StandardTableAdapter åˆå§‹åŒ–
      try {
        const standardAdapter = new StandardTableAdapter();
        const columns = standardAdapter.getColumns();
        const success = columns.length === 4;
        logTest('StandardTableAdapter åˆå§‹åŒ–', success,
          `æˆåŠŸå‰µå»ºé©é…å™¨ï¼Œæœ‰ ${columns.length} å€‹åˆ—`);
      } catch (e) {
        logTest('StandardTableAdapter åˆå§‹åŒ–', false, `éŒ¯èª¤: ${e.message}`);
      }

      // æ¸¬è©¦ 6: RulesTableAdapter åˆå§‹åŒ–
      try {
        const rulesAdapter = new RulesTableAdapter();
        const columns = rulesAdapter.getColumns();
        const success = columns.length === 3;
        logTest('RulesTableAdapter åˆå§‹åŒ–', success,
          `æˆåŠŸå‰µå»ºé©é…å™¨ï¼Œæœ‰ ${columns.length} å€‹åˆ—`);
      } catch (e) {
        logTest('RulesTableAdapter åˆå§‹åŒ–', false, `éŒ¯èª¤: ${e.message}`);
      }

      // æ¸¬è©¦ 7: TableRenderer åˆå§‹åŒ–
      try {
        // å‰µå»ºè‡¨æ™‚å®¹å™¨
        const container = document.createElement('div');
        container.className = 'csv-table-container';
        document.body.appendChild(container);

        const renderer = new TableRenderer('.csv-table-container', new CSVTableAdapter());
        logTest('TableRenderer åˆå§‹åŒ–', true, 'æˆåŠŸå‰µå»º TableRenderer å¯¦ä¾‹');

        document.body.removeChild(container);
      } catch (e) {
        logTest('TableRenderer åˆå§‹åŒ–', false, `éŒ¯èª¤: ${e.message}`);
      }

      // æ¸¬è©¦ 8: é©é…å™¨æ’åºæ”¯æŒ
      try {
        const csvAdapter = new CSVTableAdapter();
        const canSortCode = csvAdapter.canSort('code');
        const canSortName = csvAdapter.canSort('name');
        const canSortPoints = csvAdapter.canSort('points');
        const success = canSortCode && canSortName && canSortPoints;
        logTest('é©é…å™¨æ’åºæ”¯æŒ', success,
          `Code: ${canSortCode}, Name: ${canSortName}, Points: ${canSortPoints}`);
      } catch (e) {
        logTest('é©é…å™¨æ’åºæ”¯æŒ', false, `éŒ¯èª¤: ${e.message}`);
      }

      // æ¸¬è©¦ 9: HTML è½‰ç¾©
      try {
        const csvAdapter = new CSVTableAdapter();
        const escaped = csvAdapter.escapeHtml('<script>alert("xss")</script>');
        const success = escaped.includes('&lt;') && escaped.includes('&gt;');
        logTest('HTML è½‰ç¾©', success,
          `è½‰ç¾©çµæœ: ${escaped}`);
      } catch (e) {
        logTest('HTML è½‰ç¾©', false, `éŒ¯èª¤: ${e.message}`);
      }

      // æ¸¬è©¦ 10: ç²å–æ’åºå€¼
      try {
        const csvAdapter = new CSVTableAdapter();
        const row = { code: 'TEST001', points: '500' };
        const codeValue = csvAdapter.getSortValue(row, 'code');
        const pointsValue = csvAdapter.getSortValue(row, 'points');
        const success = codeValue === 'test001' && pointsValue === 500;
        logTest('ç²å–æ’åºå€¼', success,
          `Code æ’åºå€¼: ${codeValue} (é¡å‹: ${typeof codeValue}), Points: ${pointsValue} (é¡å‹: ${typeof pointsValue})`);
      } catch (e) {
        logTest('ç²å–æ’åºå€¼', false, `éŒ¯èª¤: ${e.message}`);
      }

      // é¡¯ç¤ºæ¸¬è©¦æ‘˜è¦
      setTimeout(() => {
        const passed = results.filter(r => r.success).length;
        const total = results.length;
        const summary = document.createElement('div');
        summary.style.marginTop = '20px';
        summary.style.padding = '15px';
        summary.style.background = '#e8f5e9';
        summary.style.border = '2px solid #4caf50';
        summary.style.borderRadius = '6px';
        summary.innerHTML = `<h3>âœ“ æ¸¬è©¦æ‘˜è¦</h3><p><strong>é€šé: ${passed}/${total}</strong></p><p>æ‰€æœ‰é©é…å™¨å’Œæ¸²æŸ“å™¨å·²æˆåŠŸå¯¦ç¾ï¼</p>`;
        document.getElementById('results').insertBefore(summary, document.getElementById('results').firstChild);
      }, 100);
    </script>
  </div>
</body>
</html>
