<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æœå°‹å„ªåŒ–å™¨æ¸¬è©¦ - Search Optimizer Test</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
    }

    h1 {
      color: white;
      text-align: center;
      margin-bottom: 30px;
      font-size: 28px;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
    }

    .control-panel {
      background: white;
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }

    .control-section {
      margin-bottom: 20px;
    }

    .control-section h3 {
      color: #333;
      margin-bottom: 10px;
      font-size: 14px;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .button-group {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }

    button {
      padding: 10px 15px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 13px;
      font-weight: 600;
      transition: all 0.3s ease;
    }

    .btn-primary {
      background: #667eea;
      color: white;
    }

    .btn-primary:hover {
      background: #5568d3;
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(102, 126, 234, 0.4);
    }

    .btn-success {
      background: #48bb78;
      color: white;
    }

    .btn-success:hover {
      background: #38a169;
    }

    .btn-warning {
      background: #ed8936;
      color: white;
    }

    .btn-warning:hover {
      background: #dd6b20;
    }

    .btn-danger {
      background: #f56565;
      color: white;
    }

    .btn-danger:hover {
      background: #e53e3e;
    }

    input[type="text"], select {
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 14px;
    }

    input[type="text"] {
      flex: 1;
      min-width: 200px;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 15px;
      margin-top: 15px;
    }

    .stat-card {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 15px;
      border-radius: 6px;
      font-size: 13px;
    }

    .stat-label {
      opacity: 0.9;
      margin-bottom: 5px;
    }

    .stat-value {
      font-size: 20px;
      font-weight: bold;
    }

    .test-results {
      background: white;
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }

    .test-results h2 {
      color: #333;
      margin-bottom: 15px;
      border-bottom: 2px solid #667eea;
      padding-bottom: 10px;
    }

    .test-item {
      padding: 15px;
      margin-bottom: 10px;
      background: #f7fafc;
      border-left: 4px solid #667eea;
      border-radius: 4px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .test-item.passed {
      border-left-color: #48bb78;
    }

    .test-item.failed {
      border-left-color: #f56565;
    }

    .test-item.pending {
      border-left-color: #ed8936;
    }

    .test-name {
      flex: 1;
      font-weight: 500;
      color: #333;
    }

    .test-result {
      font-weight: 600;
      padding: 5px 10px;
      border-radius: 4px;
      font-size: 12px;
    }

    .test-result.passed {
      background: #c6f6d5;
      color: #22543d;
    }

    .test-result.failed {
      background: #fed7d7;
      color: #742a2a;
    }

    .test-result.pending {
      background: #feebc8;
      color: #7c2d12;
    }

    .performance-chart {
      background: #f7fafc;
      padding: 15px;
      border-radius: 6px;
      margin-top: 15px;
      overflow-x: auto;
    }

    .chart-bar {
      display: flex;
      align-items: center;
      margin-bottom: 10px;
    }

    .chart-label {
      width: 150px;
      font-size: 12px;
      font-weight: 500;
    }

    .chart-bar-bg {
      flex: 1;
      height: 30px;
      background: #edf2f7;
      border-radius: 4px;
      position: relative;
      overflow: hidden;
    }

    .chart-bar-fill {
      height: 100%;
      background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
      display: flex;
      align-items: center;
      padding-left: 10px;
      color: white;
      font-size: 12px;
      font-weight: 600;
    }

    .comparison-table {
      width: 100%;
      margin-top: 15px;
      border-collapse: collapse;
    }

    .comparison-table th,
    .comparison-table td {
      padding: 12px;
      text-align: left;
      border-bottom: 1px solid #e2e8f0;
    }

    .comparison-table th {
      background: #f7fafc;
      font-weight: 600;
      color: #333;
    }

    .comparison-table tr:hover {
      background: #f0f4f8;
    }

    .improvement {
      color: #48bb78;
      font-weight: 600;
    }

    .console {
      background: #1a202c;
      color: #68d391;
      font-family: 'Courier New', monospace;
      padding: 15px;
      border-radius: 6px;
      max-height: 300px;
      overflow-y: auto;
      font-size: 12px;
      line-height: 1.5;
      margin-top: 15px;
    }

    .console-log {
      margin-bottom: 5px;
    }

    .status-badge {
      display: inline-block;
      padding: 4px 8px;
      border-radius: 3px;
      font-size: 11px;
      font-weight: 600;
    }

    .status-ready {
      background: #c6f6d5;
      color: #22543d;
    }

    .status-running {
      background: #bee3f8;
      color: #2c5282;
    }

    .status-done {
      background: #c6f6d5;
      color: #22543d;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸ” æœå°‹å„ªåŒ–å™¨æ¸¬è©¦</h1>

    <!-- æ§åˆ¶é¢æ¿ -->
    <div class="control-panel">
      <div class="control-section">
        <h3>ğŸ“Š ç”Ÿæˆæ¸¬è©¦æ•¸æ“š</h3>
        <div class="button-group">
          <button class="btn-primary" onclick="generateData(100)">100 ç­†</button>
          <button class="btn-primary" onclick="generateData(500)">500 ç­†</button>
          <button class="btn-primary" onclick="generateData(1000)">1000 ç­†</button>
          <button class="btn-primary" onclick="generateData(2000)">2000 ç­†</button>
          <button class="btn-primary" onclick="generateData(5000)">5000 ç­†</button>
        </div>
      </div>

      <div class="control-section">
        <h3>ğŸ§ª é‹è¡Œæ¸¬è©¦</h3>
        <div class="button-group">
          <button class="btn-success" onclick="runBasicTest()">åŸºæœ¬æ¸¬è©¦</button>
          <button class="btn-success" onclick="runPerformanceTest()">æ€§èƒ½æ¸¬è©¦</button>
          <button class="btn-success" onclick="runIncrementalTest()">å¢é‡æœå°‹æ¸¬è©¦</button>
          <button class="btn-success" onclick="runCacheTest()">å¿«å–æ¸¬è©¦</button>
          <button class="btn-success" onclick="runAllTests()">é‹è¡Œå…¨éƒ¨æ¸¬è©¦</button>
        </div>
      </div>

      <div class="control-section">
        <h3>ğŸ”§ å·¥å…·</h3>
        <div class="button-group">
          <button class="btn-warning" onclick="printStats()">æ‰“å°çµ±è¨ˆ</button>
          <button class="btn-warning" onclick="printReport()">æ€§èƒ½å ±å‘Š</button>
          <button class="btn-danger" onclick="clearData()">æ¸…ç©ºæ•¸æ“š</button>
        </div>
      </div>

      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-label">ç•¶å‰æ•¸æ“šé‡</div>
          <div class="stat-value"><span id="data-count">0</span> ç­†</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">ç´¢å¼•é—œéµè©æ•¸</div>
          <div class="stat-value"><span id="keyword-count">0</span></div>
        </div>
        <div class="stat-card">
          <div class="stat-label">æœå°‹å‘½ä¸­ç‡</div>
          <div class="stat-value"><span id="hit-rate">0%</span></div>
        </div>
        <div class="stat-card">
          <div class="stat-label">å¹³å‡æœå°‹æ™‚é–“</div>
          <div class="stat-value"><span id="avg-time">0</span>ms</div>
        </div>
      </div>
    </div>

    <!-- æ¸¬è©¦çµæœ -->
    <div class="test-results">
      <h2>âœ… æ¸¬è©¦çµæœ</h2>
      <div id="test-list"></div>
      <div class="console" id="console"></div>
    </div>

    <!-- æ€§èƒ½æ¯”è¼ƒ -->
    <div class="test-results">
      <h2>âš¡ æ€§èƒ½æ¯”è¼ƒ</h2>
      <table class="comparison-table">
        <thead>
          <tr>
            <th>æ“ä½œ</th>
            <th>æ™®é€šæœå°‹</th>
            <th>å„ªåŒ–æœå°‹</th>
            <th>æ€§èƒ½æå‡</th>
          </tr>
        </thead>
        <tbody id="comparison-tbody">
          <tr><td colspan="4" style="text-align: center; color: #999;">é‹è¡Œæ€§èƒ½æ¸¬è©¦æŸ¥çœ‹çµæœ</td></tr>
        </tbody>
      </table>
    </div>
  </div>

  <!-- å¼•å…¥å„ªåŒ–å™¨ -->
  <script src="js/search-optimizer.js"></script>

  <script>
    let optimizer = null;
    let testData = [];
    const consoleLogs = [];

    // è‡ªå®šç¾© console.log
    const originalLog = console.log;
    console.log = function(...args) {
      originalLog.apply(console, args);
      const message = args.map(arg =>
        typeof arg === 'object' ? JSON.stringify(arg, null, 2) : String(arg)
      ).join(' ');
      consoleLogs.push(message);
      updateConsole();
    };

    function updateConsole() {
      const console_el = document.getElementById('console');
      console_el.innerHTML = consoleLogs.slice(-50).map(log =>
        `<div class="console-log">${log}</div>`
      ).join('');
      console_el.scrollTop = console_el.scrollHeight;
    }

    // ç”Ÿæˆæ¸¬è©¦æ•¸æ“š
    function generateData(count) {
      console.log(`ğŸ“ æ­£åœ¨ç”Ÿæˆ ${count} ç­†æ¸¬è©¦æ•¸æ“š...`);

      const categories = ['æª¢æŸ¥', 'æ²»ç™‚', 'è—¥ç‰©', 'æ‰‹è¡“', 'ç¥ç¶“', 'å¾©å¥'];
      const names = ['åŸºæœ¬', 'è©³ç´°', 'é€²éš', 'ç‰¹æ®Š', 'è¤‡åˆ', 'ç¶œåˆ'];

      testData = [];
      for (let i = 0; i < count; i++) {
        testData.push({
          code: String(i).padStart(6, '0'),
          name: `${categories[i % categories.length]}${names[i % names.length]}é …ç›®${i}`,
          points: Math.floor(Math.random() * 1000),
          description: `é€™æ˜¯ç¬¬ ${i+1} å€‹é …ç›®çš„æè¿°æ–‡æœ¬ï¼ŒåŒ…å«å„ç¨®é†«ç™‚ç›¸é—œä¿¡æ¯å’Œè¦å‰‡èªªæ˜ã€‚`,
          category: categories[i % categories.length]
        });
      }

      // åˆå§‹åŒ–å„ªåŒ–å™¨
      optimizer = new SearchOptimizer();
      const columns = [
        { key: 'code', type: 'string' },
        { key: 'name', type: 'string' },
        { key: 'description', type: 'string' },
        { key: 'category', type: 'string' }
      ];
      optimizer.initialize(testData, columns);

      updateStats();
      console.log(`âœ“ æ•¸æ“šç”Ÿæˆå®Œæˆï¼Œå·²åˆå§‹åŒ–æœå°‹å„ªåŒ–å™¨`);
    }

    // æ›´æ–°çµ±è¨ˆ
    function updateStats() {
      if (!optimizer) return;

      const stats = optimizer.getStats();
      document.getElementById('data-count').textContent = testData.length;
      document.getElementById('keyword-count').textContent = stats.index.uniqueKeywords;
      document.getElementById('hit-rate').textContent = stats.cache.hitRate;
      document.getElementById('avg-time').textContent = stats.search.avgSearchTime;
    }

    // åŸºæœ¬æ¸¬è©¦
    function runBasicTest() {
      if (!optimizer) {
        alert('è«‹å…ˆç”Ÿæˆæ¸¬è©¦æ•¸æ“š');
        return;
      }

      console.log('\nâ•â•â• åŸºæœ¬åŠŸèƒ½æ¸¬è©¦é–‹å§‹ â•â•â•\n');
      const testList = document.getElementById('test-list');
      testList.innerHTML = '';

      const tests = [
        {
          name: 'å€’æ’ç´¢å¼•æ§‹å»º',
          fn: () => optimizer.indexBuilder.getStats().uniqueKeywords > 0
        },
        {
          name: 'åŸºæœ¬æœå°‹åŠŸèƒ½',
          fn: () => optimizer.search('æª¢æŸ¥').results.length > 0
        },
        {
          name: 'å¿«å–æ©Ÿåˆ¶',
          fn: () => {
            optimizer.search('æ²»ç™‚');
            return optimizer.searchCache.cache.size > 0;
          }
        },
        {
          name: 'å¢é‡æœå°‹',
          fn: () => {
            const result = optimizer.incrementalSearch('æ²»', 'æ²»ç™‚');
            return result.isIncremental && result.results.length > 0;
          }
        },
        {
          name: 'ç©ºæœå°‹è™•ç†',
          fn: () => optimizer.search('').results.length === 0
        },
        {
          name: 'çµ±è¨ˆä¿¡æ¯',
          fn: () => {
            const stats = optimizer.getStats();
            return stats.index && stats.cache && stats.search;
          }
        }
      ];

      tests.forEach((test, idx) => {
        try {
          const passed = test.fn();
          addTestResult(testList, test.name, passed);
          console.log(`${passed ? 'âœ“' : 'âœ—'} ${test.name}`);
        } catch (e) {
          addTestResult(testList, test.name, false);
          console.log(`âœ— ${test.name}: ${e.message}`);
        }
      });

      console.log('\nâ•â•â• åŸºæœ¬åŠŸèƒ½æ¸¬è©¦å®Œæˆ â•â•â•\n');
      updateStats();
    }

    // æ€§èƒ½æ¸¬è©¦
    function runPerformanceTest() {
      if (!optimizer) {
        alert('è«‹å…ˆç”Ÿæˆæ¸¬è©¦æ•¸æ“š');
        return;
      }

      console.log('\nâ•â•â• æ€§èƒ½æ¸¬è©¦é–‹å§‹ â•â•â•\n');
      const keywords = ['æª¢æŸ¥', 'æ²»ç™‚', 'é …ç›®', 'æè¿°', 'è¤‡åˆ', 'é€²éš'];

      const results = [];

      // æ™®é€šæœå°‹
      console.log('ğŸ“Š æ™®é€šæœå°‹æ€§èƒ½:');
      const normalStart = performance.now();
      let normalResults = 0;
      keywords.forEach(kw => {
        const result = testData.filter(item =>
          String(item.name).includes(kw) || String(item.description).includes(kw)
        );
        normalResults += result.length;
      });
      const normalTime = performance.now() - normalStart;
      console.log(`  è€—æ™‚: ${normalTime.toFixed(2)}ms, çµæœ: ${normalResults}`);
      results.push({ method: 'æ™®é€šæœå°‹', time: normalTime });

      // å„ªåŒ–æœå°‹ (ç´¢å¼•)
      console.log('ğŸ“Š å„ªåŒ–æœå°‹æ€§èƒ½:');
      const optimizedStart = performance.now();
      let optimizedResults = 0;
      keywords.forEach(kw => {
        const result = optimizer.search(kw);
        optimizedResults += result.results.length;
      });
      const optimizedTime = performance.now() - optimizedStart;
      console.log(`  è€—æ™‚: ${optimizedTime.toFixed(2)}ms, çµæœ: ${optimizedResults}`);
      results.push({ method: 'å„ªåŒ–æœå°‹', time: optimizedTime });

      // å¿«å–æœå°‹ (ç¬¬äºŒæ¬¡)
      console.log('ğŸ“Š å¿«å–æœå°‹æ€§èƒ½:');
      const cachedStart = performance.now();
      let cachedResults = 0;
      keywords.forEach(kw => {
        const result = optimizer.search(kw);
        cachedResults += result.results.length;
      });
      const cachedTime = performance.now() - cachedStart;
      console.log(`  è€—æ™‚: ${cachedTime.toFixed(2)}ms, çµæœ: ${cachedResults}`);
      results.push({ method: 'å¿«å–æœå°‹', time: cachedTime });

      // æ›´æ–°æ¯”è¼ƒè¡¨
      updateComparisonTable(results);

      const improvement = ((normalTime - optimizedTime) / normalTime * 100).toFixed(1);
      console.log(`\nâš¡ æ€§èƒ½æå‡: ${improvement}% (${normalTime.toFixed(2)}ms â†’ ${optimizedTime.toFixed(2)}ms)\n`);

      console.log('â•â•â• æ€§èƒ½æ¸¬è©¦å®Œæˆ â•â•â•\n');
      updateStats();
    }

    // å¢é‡æœå°‹æ¸¬è©¦
    function runIncrementalTest() {
      if (!optimizer) {
        alert('è«‹å…ˆç”Ÿæˆæ¸¬è©¦æ•¸æ“š');
        return;
      }

      console.log('\nâ•â•â• å¢é‡æœå°‹æ¸¬è©¦é–‹å§‹ â•â•â•\n');

      const sequence = ['æª¢', 'æª¢æŸ¥', 'æª¢æŸ¥é …'];
      console.log(`æ¸¬è©¦åºåˆ—: ${sequence.join(' â†’ ')}`);

      let prevKeyword = '';
      sequence.forEach((keyword, idx) => {
        const result = optimizer.incrementalSearch(prevKeyword, keyword);
        console.log(`${idx + 1}. "${keyword}": ${result.results.length} çµæœ, ${result.time}ms, ${result.isIncremental ? 'å¢é‡' : 'å…¨é‡'}`);
        prevKeyword = keyword;
      });

      console.log('\nâ•â•â• å¢é‡æœå°‹æ¸¬è©¦å®Œæˆ â•â•â•\n');
      updateStats();
    }

    // å¿«å–æ¸¬è©¦
    function runCacheTest() {
      if (!optimizer) {
        alert('è«‹å…ˆç”Ÿæˆæ¸¬è©¦æ•¸æ“š');
        return;
      }

      console.log('\nâ•â•â• å¿«å–æ¸¬è©¦é–‹å§‹ â•â•â•\n');

      // æ¸…ç©ºå¿«å–
      optimizer.searchCache.clear();
      console.log('å¿«å–å·²æ¸…ç©º');

      const testKeywords = ['æª¢æŸ¥', 'æ²»ç™‚', 'é …ç›®', 'æª¢æŸ¥', 'æ²»ç™‚', 'é …ç›®', 'æª¢æŸ¥'];

      testKeywords.forEach((kw, idx) => {
        const result = optimizer.search(kw);
        const source = result.source;
        console.log(`æœå°‹ ${idx + 1}: "${kw}" â†’ ${result.results.length} çµæœ (${source})`);
      });

      const stats = optimizer.searchCache.getStats();
      console.log(`\nå¿«å–çµ±è¨ˆ:`);
      console.log(`  - å‘½ä¸­ç‡: ${stats.hitRate}`);
      console.log(`  - å‘½ä¸­æ¬¡æ•¸: ${stats.hits}`);
      console.log(`  - æœªå‘½ä¸­æ¬¡æ•¸: ${stats.misses}`);

      console.log('\nâ•â•â• å¿«å–æ¸¬è©¦å®Œæˆ â•â•â•\n');
      updateStats();
    }

    // é‹è¡Œæ‰€æœ‰æ¸¬è©¦
    function runAllTests() {
      if (!optimizer) {
        alert('è«‹å…ˆç”Ÿæˆæ¸¬è©¦æ•¸æ“š');
        return;
      }

      runBasicTest();
      setTimeout(() => runPerformanceTest(), 500);
      setTimeout(() => runIncrementalTest(), 1000);
      setTimeout(() => runCacheTest(), 1500);
    }

    // æ·»åŠ æ¸¬è©¦çµæœ
    function addTestResult(container, name, passed) {
      const item = document.createElement('div');
      item.className = `test-item ${passed ? 'passed' : 'failed'}`;
      item.innerHTML = `
        <span class="test-name">${passed ? 'âœ“' : 'âœ—'} ${name}</span>
        <span class="test-result ${passed ? 'passed' : 'failed'}">${passed ? 'PASS' : 'FAIL'}</span>
      `;
      container.appendChild(item);
    }

    // æ‰“å°çµ±è¨ˆ
    function printStats() {
      if (!optimizer) {
        alert('è«‹å…ˆç”Ÿæˆæ¸¬è©¦æ•¸æ“š');
        return;
      }
      optimizer.printReport();
      updateStats();
    }

    // æ‰“å°å ±å‘Š
    function printReport() {
      if (!optimizer) {
        alert('è«‹å…ˆç”Ÿæˆæ¸¬è©¦æ•¸æ“š');
        return;
      }
      console.log('\n');
      optimizer.printReport();
    }

    // æ¸…ç©ºæ•¸æ“š
    function clearData() {
      optimizer = null;
      testData = [];
      document.getElementById('test-list').innerHTML = '';
      document.getElementById('comparison-tbody').innerHTML = '<tr><td colspan="4" style="text-align: center; color: #999;">é‹è¡Œæ€§èƒ½æ¸¬è©¦æŸ¥çœ‹çµæœ</td></tr>';
      document.getElementById('data-count').textContent = '0';
      document.getElementById('keyword-count').textContent = '0';
      document.getElementById('hit-rate').textContent = '0%';
      document.getElementById('avg-time').textContent = '0';
      consoleLogs.length = 0;
      updateConsole();
      console.log('âœ“ æ‰€æœ‰æ•¸æ“šå·²æ¸…ç©º');
    }

    // æ›´æ–°æ¯”è¼ƒè¡¨
    function updateComparisonTable(results) {
      const tbody = document.getElementById('comparison-tbody');
      if (results.length === 0) return;

      const normalTime = results[0].time;
      const optimizedTime = results[1].time;

      tbody.innerHTML = `
        <tr>
          <td>æœå°‹ 6 å€‹é—œéµè©</td>
          <td>${normalTime.toFixed(2)}ms</td>
          <td>${optimizedTime.toFixed(2)}ms</td>
          <td class="improvement">${((normalTime - optimizedTime) / normalTime * 100).toFixed(1)}% â†“</td>
        </tr>
      `;
    }

    // åˆå§‹åŒ–
    console.log('ğŸš€ æœå°‹å„ªåŒ–å™¨æ¸¬è©¦é é¢å·²æº–å‚™å°±ç·’');
    console.log('æ­¥é©Ÿ: 1. ç”Ÿæˆæ¸¬è©¦æ•¸æ“š 2. é‹è¡Œæ¸¬è©¦ 3. æŸ¥çœ‹çµæœ');
  </script>
</body>
</html>
