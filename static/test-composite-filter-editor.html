<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>è¤‡åˆç¯©é¸ç·¨è¼¯å™¨ - Composite Filter Editor Test</title>
  <link rel="stylesheet" href="css/composite-filter-editor.css">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }
    .container { max-width: 1200px; margin: 0 auto; }
    h1 {
      color: white;
      text-align: center;
      margin-bottom: 30px;
      font-size: 28px;
    }
    .layout {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin-bottom: 20px;
    }
    .panel {
      background: white;
      border-radius: 8px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
      overflow: hidden;
    }
    .panel-header {
      background: #667eea;
      color: white;
      padding: 15px;
      font-weight: 600;
    }
    .panel-content {
      padding: 20px;
    }
    .demo-section {
      background: white;
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }
    .demo-section h2 {
      color: #333;
      margin-bottom: 15px;
      border-bottom: 2px solid #667eea;
      padding-bottom: 10px;
    }
    .controls {
      background: #f7fafc;
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 15px;
    }
    .control-group {
      margin-bottom: 10px;
    }
    .control-group button {
      padding: 10px 15px;
      margin-right: 10px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-weight: 600;
      font-size: 13px;
      transition: all 0.2s;
      margin-bottom: 8px;
    }
    .btn-primary { background: #667eea; color: white; }
    .btn-primary:hover { background: #5568d3; }
    .btn-success { background: #48bb78; color: white; }
    .btn-success:hover { background: #38a169; }
    .console {
      background: #1a202c;
      color: #68d391;
      font-family: 'Courier New', monospace;
      padding: 15px;
      border-radius: 6px;
      max-height: 300px;
      overflow-y: auto;
      font-size: 12px;
      line-height: 1.5;
    }
    .results-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 15px;
      font-size: 13px;
    }
    .results-table th {
      background: #667eea;
      color: white;
      padding: 10px;
      text-align: left;
      font-weight: 600;
    }
    .results-table td {
      padding: 10px;
      border-bottom: 1px solid #e2e8f0;
    }
    .results-table tr:hover {
      background: #f7fafc;
    }
    @media (max-width: 1024px) {
      .layout {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸ›ï¸ è¤‡åˆç¯©é¸ç·¨è¼¯å™¨</h1>

    <!-- ç·¨è¼¯å™¨å’Œæ¨¡æ¿ç®¡ç† -->
    <div class="layout">
      <div class="panel">
        <div class="panel-header">ç¯©é¸ç·¨è¼¯å™¨</div>
        <div class="panel-content">
          <div id="filter-editor"></div>
        </div>
      </div>

      <div class="panel">
        <div class="panel-header">ä¿å­˜çš„æ¨¡æ¿</div>
        <div class="panel-content">
          <div id="template-manager"></div>
        </div>
      </div>
    </div>

    <!-- æ¸¬è©¦çµæœ -->
    <div class="demo-section">
      <h2>ğŸ“Š ç¯©é¸çµæœ</h2>
      <div class="controls">
        <div class="control-group">
          <button class="btn-primary" onclick="generateTestData(100)">ç”Ÿæˆ 100 ç­†æ¸¬è©¦æ•¸æ“š</button>
          <button class="btn-primary" onclick="generateTestData(1000)">ç”Ÿæˆ 1000 ç­†æ•¸æ“š</button>
          <button class="btn-success" onclick="applyFilter()">æ‡‰ç”¨ç¯©é¸</button>
        </div>
      </div>
      <div id="results-container"></div>
    </div>

    <!-- å¯¦æ™‚æ—¥èªŒ -->
    <div class="demo-section">
      <h2>ğŸ“‹ å¯¦æ™‚æ—¥èªŒ</h2>
      <div class="console" id="console"></div>
    </div>
  </div>

  <!-- å¼•å…¥ä¾è³´è…³æœ¬ -->
  <script src="js/advanced-filter.js"></script>
  <script src="js/composite-filter-editor.js"></script>

  <script>
    let editor = null;
    let templateManager = null;
    let testData = [];
    let filteredData = [];
    const consoleLogs = [];

    // æ””æˆª console.log
    const originalLog = console.log;
    console.log = function(...args) {
      originalLog.apply(console, args);
      consoleLogs.push(args.join(' '));
      updateConsole();
    };

    function updateConsole() {
      const el = document.getElementById('console');
      el.innerHTML = consoleLogs.slice(-50).map(log =>
        `<div>[${new Date().toLocaleTimeString()}] ${log}</div>`
      ).join('');
      el.scrollTop = el.scrollHeight;
    }

    // åˆ—é…ç½®
    const columns = [
      {
        field: 'category',
        label: 'é …ç›®é¡åˆ¥',
        type: 'select',
        options: ['æª¢æŸ¥', 'æ²»ç™‚', 'æ‰‹è¡“', 'è—¥ç‰©', 'æª¢é©—']
      },
      {
        field: 'name',
        label: 'é …ç›®åç¨±',
        type: 'string'
      },
      {
        field: 'points',
        label: 'è¨ºç™‚é»æ•¸',
        type: 'number'
      },
      {
        field: 'date',
        label: 'ç”Ÿæ•ˆæ—¥æœŸ',
        type: 'date'
      },
      {
        field: 'status',
        label: 'ç‹€æ…‹',
        type: 'select',
        options: ['æœ‰æ•ˆ', 'åœç”¨', 'å¾…å¯©', 'ä¿®è¨‚ä¸­']
      },
      {
        field: 'coverage',
        label: 'çµ¦ä»˜ç¯„åœ',
        type: 'number'
      }
    ];

    // åˆå§‹åŒ–ç·¨è¼¯å™¨
    function initializeEditor() {
      editor = new CompositeFilterEditor('#filter-editor', columns);
      editor.initialize({ columns });

      editor.onChange((result) => {
        console.log('âœ“ ç¯©é¸å·²æ‡‰ç”¨');
        console.log(`  é‚è¼¯: ${result.logic}`);
        console.log(`  æ¢ä»¶æ•¸: ${result.conditions.length}`);
      });

      console.log('âœ“ è¤‡åˆç¯©é¸ç·¨è¼¯å™¨å·²åˆå§‹åŒ–');
    }

    // åˆå§‹åŒ–æ¨¡æ¿ç®¡ç†å™¨
    function initializeTemplateManager() {
      templateManager = new FilterTemplateManager('#template-manager');
      templateManager.initialize();

      templateManager.onAction((action) => {
        if (action.action === 'load') {
          editor.loadTemplate(action.template.name);
          console.log(`âœ“ æ¨¡æ¿å·²åŠ è¼‰: ${action.template.name}`);
        }
      });

      console.log('âœ“ æ¨¡æ¿ç®¡ç†å™¨å·²åˆå§‹åŒ–');
    }

    // ç”Ÿæˆæ¸¬è©¦æ•¸æ“š
    function generateTestData(count) {
      const categories = ['æª¢æŸ¥', 'æ²»ç™‚', 'æ‰‹è¡“', 'è—¥ç‰©', 'æª¢é©—'];
      const statuses = ['æœ‰æ•ˆ', 'åœç”¨', 'å¾…å¯©', 'ä¿®è¨‚ä¸­'];
      const names = [
        'è¡€æ¶²æª¢æŸ¥', 'å¿ƒé›»åœ–', 'è¶…éŸ³æ³¢æª¢æŸ¥', 'æ³¨å°„æ²»ç™‚', 'æ‹”ç‰™',
        'æ ¹ç®¡æ²»ç™‚', 'æ´—ç‰™', 'è£œç‰™', 'é…è—¥', 'æ›è™Ÿ'
      ];

      testData = [];
      for (let i = 0; i < count; i++) {
        testData.push({
          id: i + 1,
          category: categories[Math.floor(Math.random() * categories.length)],
          name: names[Math.floor(Math.random() * names.length)],
          points: Math.floor(Math.random() * 1000) + 100,
          date: new Date(2025, Math.floor(Math.random() * 12), Math.floor(Math.random() * 28) + 1).toISOString().split('T')[0],
          status: statuses[Math.floor(Math.random() * statuses.length)],
          coverage: Math.floor(Math.random() * 100) + 50
        });
      }

      console.log(`âœ“ å·²ç”Ÿæˆ ${count} ç­†æ¸¬è©¦æ•¸æ“š`);
      displayResults(testData);
    }

    // æ‡‰ç”¨ç¯©é¸
    function applyFilter() {
      if (testData.length === 0) {
        alert('è«‹å…ˆç”Ÿæˆæ¸¬è©¦æ•¸æ“š');
        return;
      }

      const filter = editor.toCompositeFilter();
      const advFilter = new AdvancedFilter();

      // è¤‡è£½æ¢ä»¶åˆ°é«˜ç´šç¯©é¸å™¨
      editor.conditions.forEach(cond => {
        if (cond.value !== '' && cond.value !== null) {
          advFilter.addCondition(cond.field, cond.operator, cond.value);
        }
      });

      // åŸ·è¡Œç¯©é¸
      const startTime = performance.now();
      const result = advFilter.filter(testData);
      const endTime = performance.now();

      filteredData = result.results;

      console.log(`âœ“ ç¯©é¸å®Œæˆ`);
      console.log(`  åŸå§‹: ${testData.length} ç­†`);
      console.log(`  çµæœ: ${filteredData.length} ç­†`);
      console.log(`  è€—æ™‚: ${(endTime - startTime).toFixed(2)}ms`);
      console.log(`  ç¬¦åˆç‡: ${((filteredData.length / testData.length) * 100).toFixed(1)}%`);

      displayResults(filteredData);
    }

    // é¡¯ç¤ºçµæœ
    function displayResults(data) {
      const container = document.getElementById('results-container');

      if (data.length === 0) {
        container.innerHTML = '<p style="text-align: center; color: #a0aec0;">ç„¡çµæœ</p>';
        return;
      }

      const displayCount = Math.min(data.length, 10);
      let html = `
        <p style="color: #666; margin-bottom: 10px;">
          é¡¯ç¤ºå‰ ${displayCount} ç­†ï¼ˆå…± ${data.length} ç­†ï¼‰
        </p>
        <table class="results-table">
          <thead>
            <tr>
              <th>ID</th>
              <th>é¡åˆ¥</th>
              <th>åç¨±</th>
              <th>é»æ•¸</th>
              <th>æ—¥æœŸ</th>
              <th>ç‹€æ…‹</th>
              <th>çµ¦ä»˜ç¯„åœ</th>
            </tr>
          </thead>
          <tbody>
      `;

      for (let i = 0; i < displayCount; i++) {
        const row = data[i];
        html += `
          <tr>
            <td>${row.id}</td>
            <td>${row.category}</td>
            <td>${row.name}</td>
            <td>${row.points}</td>
            <td>${row.date}</td>
            <td>${row.status}</td>
            <td>${row.coverage}%</td>
          </tr>
        `;
      }

      html += `
          </tbody>
        </table>
      `;

      container.innerHTML = html;
    }

    // é é¢åŠ è¼‰å®Œæˆ
    window.addEventListener('load', () => {
      console.log('ğŸš€ è¤‡åˆç¯©é¸ç·¨è¼¯å™¨æ¸¬è©¦é é¢å·²åŠ è¼‰');
      initializeEditor();
      initializeTemplateManager();

      // ç”Ÿæˆåˆå§‹æ¸¬è©¦æ•¸æ“š
      generateTestData(100);
    });
  </script>
</body>
</html>
