<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>è¡¨æ ¼æ¨™ç±¤ç³»çµ±æ¸¬è©¦</title>
  <link rel="stylesheet" href="css/medical-tree.css">
  <style>
    body {
      padding: 20px;
      background: #f5f5f5;
    }
    .test-container {
      max-width: 1200px;
      margin: 0 auto;
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    .test-section {
      margin-bottom: 30px;
      border: 1px solid #e0e0e0;
      padding: 15px;
      border-radius: 6px;
    }
    .test-section h3 {
      margin-top: 0;
      color: #333;
      border-bottom: 2px solid #667eea;
      padding-bottom: 10px;
    }
    .test-result {
      padding: 10px;
      margin: 10px 0;
      border-radius: 4px;
      background: #f0f4ff;
      border-left: 4px solid #667eea;
    }
    .test-result.success {
      background: #e8f5e9;
      border-left-color: #4caf50;
    }
    .test-result.error {
      background: #ffebee;
      border-left-color: #f44336;
    }
    .demo-container {
      padding: 15px;
      background: #fafbfc;
      border-radius: 6px;
      margin-top: 15px;
    }
    .stats {
      background: #e8f5e9;
      padding: 10px;
      border-radius: 4px;
      margin-top: 10px;
      font-family: monospace;
      font-size: 13px;
    }
  </style>
</head>
<body>
  <div class="test-container">
    <h1>ğŸ§ª è¡¨æ ¼æ¨™ç±¤ç³»çµ±æ¸¬è©¦</h1>

    <div id="results"></div>

    <!-- æ¼”ç¤ºå€åŸŸ -->
    <div class="test-section">
      <h3>ğŸ“‹ è¡¨æ ¼æ¨™ç±¤æ¼”ç¤º</h3>
      <div id="demo"></div>
    </div>
  </div>

  <script src="js/table-renderer.js"></script>
  <script src="js/table-tabs-manager.js"></script>
  <script>
    const results = [];
    const demoContainer = document.getElementById('demo');

    function logTest(name, success, details) {
      results.push({ name, success, details });
      const resultDiv = document.getElementById('results');
      const testDiv = document.createElement('div');
      testDiv.className = `test-result ${success ? 'success' : 'error'}`;
      testDiv.innerHTML = `<strong>${success ? 'âœ“' : 'âœ—'} ${name}</strong><br><small>${details}</small>`;
      resultDiv.appendChild(testDiv);
    }

    // æ¸¬è©¦ 1: TableTabsManager åˆå§‹åŒ–
    try {
      const manager = new TableTabsManager('.tabs-container');
      logTest('TableTabsManager åˆå§‹åŒ–', true, 'æˆåŠŸå‰µå»ºå¯¦ä¾‹');
    } catch (e) {
      logTest('TableTabsManager åˆå§‹åŒ–', false, `éŒ¯èª¤: ${e.message}`);
    }

    // æ¸¬è©¦ 2: è¨»å†Šå–®å€‹æ¨™ç±¤
    try {
      const manager = new TableTabsManager('.tabs-container');
      manager.registerTab({
        id: 'tab-1',
        label: 'è¡¨æ ¼ 1',
        description: 'ç¬¬ä¸€å€‹è¡¨æ ¼'
      });
      logTest('è¨»å†Šå–®å€‹æ¨™ç±¤', manager.tabs.length === 1, `å·²è¨»å†Š ${manager.tabs.length} å€‹æ¨™ç±¤`);
    } catch (e) {
      logTest('è¨»å†Šå–®å€‹æ¨™ç±¤', false, `éŒ¯èª¤: ${e.message}`);
    }

    // æ¸¬è©¦ 3: è¨»å†Šå¤šå€‹æ¨™ç±¤
    try {
      const manager = new TableTabsManager('.tabs-container');
      manager.registerTabs([
        { id: 'csv', label: 'CSV é …ç›®', description: 'è¨ºç™‚é …ç›®è¡¨' },
        { id: 'standard', label: 'æ”¯ä»˜æ¨™æº–', description: 'æ”¯ä»˜æ¨™æº–è¡¨' },
        { id: 'rules', label: 'è¦å‰‡', description: 'è¦å‰‡è¡¨' }
      ]);
      logTest('è¨»å†Šå¤šå€‹æ¨™ç±¤', manager.tabs.length === 3, `å·²è¨»å†Š ${manager.tabs.length} å€‹æ¨™ç±¤`);
    } catch (e) {
      logTest('è¨»å†Šå¤šå€‹æ¨™ç±¤', false, `éŒ¯èª¤: ${e.message}`);
    }

    // æ¸¬è©¦ 4: æ¸²æŸ“æ¨™ç±¤æ¬„ï¼ˆå–®å€‹æ¨™ç±¤ - æ‡‰éš±è—ï¼‰
    try {
      const testDiv = document.createElement('div');
      testDiv.innerHTML = `
        <div class="tabs-container"></div>
        <div class="table-tabs" style="display: none;"></div>
      `;
      document.body.appendChild(testDiv);

      const manager = new TableTabsManager('.tabs-container');
      manager.registerTab({ id: 'single', label: 'å–®è¡¨æ ¼' });
      manager.renderTabs();

      const tabsWrapper = testDiv.querySelector('.table-tabs');
      const success = tabsWrapper.style.display === 'none';
      logTest('å–®æ¨™ç±¤éš±è—', success, 'å–®å€‹æ¨™ç±¤æ™‚æ¨™ç±¤æ¬„å·²éš±è—');

      document.body.removeChild(testDiv);
    } catch (e) {
      logTest('å–®æ¨™ç±¤éš±è—', false, `éŒ¯èª¤: ${e.message}`);
    }

    // æ¸¬è©¦ 5: æ¸²æŸ“æ¨™ç±¤æ¬„ï¼ˆå¤šå€‹æ¨™ç±¤ - æ‡‰é¡¯ç¤ºï¼‰
    try {
      const testDiv = document.createElement('div');
      testDiv.innerHTML = `
        <div class="tabs-container"></div>
        <div class="table-tabs" style="display: none;"></div>
      `;
      document.body.appendChild(testDiv);

      const manager = new TableTabsManager('.tabs-container');
      manager.registerTabs([
        { id: 'tab1', label: 'è¡¨1' },
        { id: 'tab2', label: 'è¡¨2' }
      ]);
      manager.renderTabs();

      const tabsWrapper = testDiv.querySelector('.table-tabs');
      const buttons = testDiv.querySelectorAll('.tab-button');
      const success = tabsWrapper.style.display !== 'none' && buttons.length === 2;
      logTest('å¤šæ¨™ç±¤é¡¯ç¤º', success, `æ¨™ç±¤æ¬„å·²é¡¯ç¤ºï¼Œ${buttons.length} å€‹æŒ‰éˆ•`);

      document.body.removeChild(testDiv);
    } catch (e) {
      logTest('å¤šæ¨™ç±¤é¡¯ç¤º', false, `éŒ¯èª¤: ${e.message}`);
    }

    // æ¸¬è©¦ 6: æ¨™ç±¤æ¿€æ´»
    try {
      const testDiv = document.createElement('div');
      testDiv.innerHTML = `
        <div class="tabs-container"></div>
        <div class="table-tabs" style="display: none;"></div>
      `;
      document.body.appendChild(testDiv);

      const manager = new TableTabsManager('.tabs-container');
      manager.registerTabs([
        { id: 'tab-a', label: 'A' },
        { id: 'tab-b', label: 'B' }
      ]);
      manager.renderTabs();
      manager.activateTab('tab-b');

      const currentTab = manager.getCurrentTab();
      const success = currentTab && currentTab.id === 'tab-b' && currentTab.active;
      logTest('æ¨™ç±¤æ¿€æ´»', success, `ç•¶å‰æ¿€æ´»æ¨™ç±¤: ${currentTab?.id}`);

      document.body.removeChild(testDiv);
    } catch (e) {
      logTest('æ¨™ç±¤æ¿€æ´»', false, `éŒ¯èª¤: ${e.message}`);
    }

    // æ¸¬è©¦ 7: å›èª¿å‡½æ•¸
    try {
      const manager = new TableTabsManager('.tabs-container');
      let callbackCalled = false;
      let callbackTabId = null;

      manager.onTabChange((tabId) => {
        callbackCalled = true;
        callbackTabId = tabId;
      });

      manager.registerTabs([
        { id: 'tab-x', label: 'X' },
        { id: 'tab-y', label: 'Y' }
      ]);
      manager.activateTab('tab-y');

      const success = callbackCalled && callbackTabId === 'tab-y';
      logTest('æ¨™ç±¤åˆ‡æ›å›èª¿', success, `å›èª¿å·²è§¸ç™¼ï¼Œæ¨™ç±¤: ${callbackTabId}`);
    } catch (e) {
      logTest('æ¨™ç±¤åˆ‡æ›å›èª¿', false, `éŒ¯èª¤: ${e.message}`);
    }

    // æ¸¬è©¦ 8: ç²å–çµ±è¨ˆä¿¡æ¯
    try {
      const manager = new TableTabsManager('.tabs-container');
      manager.registerTabs([
        { id: 'tab1', label: 'è¡¨1' },
        { id: 'tab2', label: 'è¡¨2' },
        { id: 'tab3', label: 'è¡¨3' }
      ]);

      const stats = manager.getStats();
      const success = stats.totalTabs === 3 && stats.tabs.length === 3;
      logTest('çµ±è¨ˆä¿¡æ¯', success, `ç¸½æ¨™ç±¤æ•¸: ${stats.totalTabs}`);
    } catch (e) {
      logTest('çµ±è¨ˆä¿¡æ¯', false, `éŒ¯èª¤: ${e.message}`);
    }

    // æ¸¬è©¦ 9: HTML è½‰ç¾©
    try {
      const manager = new TableTabsManager('.tabs-container');
      const escaped = manager.escapeHtml('<script>alert("xss")</script>');
      const success = escaped.includes('&lt;') && escaped.includes('&gt;');
      logTest('HTML è½‰ç¾©', success, `è½‰ç¾©çµæœ: ${escaped}`);
    } catch (e) {
      logTest('HTML è½‰ç¾©', false, `éŒ¯èª¤: ${e.message}`);
    }

    // æ¸¬è©¦ 10: æ¸…ç©ºæ¨™ç±¤
    try {
      const manager = new TableTabsManager('.tabs-container');
      manager.registerTabs([
        { id: 'tab1', label: 'è¡¨1' },
        { id: 'tab2', label: 'è¡¨2' }
      ]);
      manager.clearTabs();
      const success = manager.tabs.length === 0 && Object.keys(manager.renderers).length === 0;
      logTest('æ¸…ç©ºæ¨™ç±¤', success, `æ¨™ç±¤å·²æ¸…ç©º`);
    } catch (e) {
      logTest('æ¸…ç©ºæ¨™ç±¤', false, `éŒ¯èª¤: ${e.message}`);
    }

    // æ¼”ç¤ºï¼šå‰µå»ºå¯¦éš›çš„è¡¨æ ¼æ¨™ç±¤ç³»çµ±
    try {
      demoContainer.innerHTML = `
        <div style="margin-bottom: 15px;">
          <h4>æ¼”ç¤ºï¼š3 å€‹è¡¨æ ¼æ¨™ç±¤</h4>
          <div class="table-tabs">
            <div class="tabs-container"></div>
          </div>
        </div>
        <div style="padding: 15px; background: white; border: 1px solid #ddd; border-radius: 4px;">
          <p><strong>ç•¶å‰æ¨™ç±¤:</strong> <span id="current-tab-label">æœªé¸æ“‡</span></p>
          <p id="tab-stats"></p>
        </div>
      `;

      const demoManager = new TableTabsManager(demoContainer.querySelector('.tabs-container'));

      // å‰µå»ºæ¨¡æ“¬çš„æ¸²æŸ“å™¨å°è±¡
      const createMockRenderer = (name) => ({
        show: function() { console.log(`é¡¯ç¤º: ${name}`); },
        hide: function() { console.log(`éš±è—: ${name}`); }
      });

      demoManager.registerTabs([
        { id: 'csv-table', label: 'ğŸ“Š CSV è¨ºç™‚é …ç›®', description: 'é†«ç™‚è¨ºç™‚é …ç›®è¡¨', renderer: createMockRenderer('CSV') },
        { id: 'standard-table', label: 'ğŸ’° æ”¯ä»˜æ¨™æº–', description: 'æ”¯ä»˜æ¨™æº–è¡¨', renderer: createMockRenderer('æ¨™æº–') },
        { id: 'rules-table', label: 'ğŸ“‹ è¦å‰‡è¡¨', description: 'çµ¦ä»˜è¦å‰‡è¡¨', renderer: createMockRenderer('è¦å‰‡') }
      ]);

      demoManager.onTabChange((tabId) => {
        const tab = demoManager.getCurrentTab();
        document.getElementById('current-tab-label').textContent = tab?.label || 'æœªçŸ¥';
        updateStats();
      });

      function updateStats() {
        const stats = demoManager.getStats();
        let statsHTML = `<strong>æ¨™ç±¤çµ±è¨ˆ:</strong> ${stats.totalTabs} å€‹æ¨™ç±¤<br>`;
        statsHTML += `<small>ç•¶å‰: ${stats.currentTab}</small>`;
        document.getElementById('tab-stats').innerHTML = statsHTML;
      }

      demoManager.renderTabs();
      updateStats();
    } catch (e) {
      demoContainer.innerHTML = `<div class="test-result error">æ¼”ç¤ºå¤±æ•—: ${e.message}</div>`;
    }

    // é¡¯ç¤ºæ¸¬è©¦æ‘˜è¦
    setTimeout(() => {
      const passed = results.filter(r => r.success).length;
      const total = results.length;
      const summary = document.createElement('div');
      summary.style.marginTop = '20px';
      summary.style.padding = '15px';
      summary.style.background = '#e8f5e9';
      summary.style.border = '2px solid #4caf50';
      summary.style.borderRadius = '6px';
      summary.innerHTML = `
        <h3>âœ“ æ¸¬è©¦æ‘˜è¦</h3>
        <p><strong>é€šé: ${passed}/${total}</strong></p>
        <p>è¡¨æ ¼æ¨™ç±¤ç³»çµ±å·²æˆåŠŸå¯¦ç¾ï¼</p>
      `;
      document.getElementById('results').insertBefore(summary, document.getElementById('results').firstChild);
    }, 100);
  </script>
</body>
</html>
