<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>è¦å‰‡è¡¨æ¸¬è©¦</title>
  <link rel="stylesheet" href="css/medical-tree.css">
  <style>
    body {
      padding: 20px;
      background: #f5f5f5;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
    }
    .test-container {
      max-width: 1400px;
      margin: 0 auto;
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    .test-section {
      margin-bottom: 30px;
      border: 1px solid #e0e0e0;
      padding: 15px;
      border-radius: 6px;
    }
    .test-section h3 {
      margin-top: 0;
      color: #333;
      border-bottom: 2px solid #ff6b6b;
      padding-bottom: 10px;
    }
    .test-result {
      padding: 10px;
      margin: 10px 0;
      border-radius: 4px;
      background: #f0f4ff;
      border-left: 4px solid #667eea;
      font-size: 14px;
    }
    .test-result.success {
      background: #e8f5e9;
      border-left-color: #4caf50;
    }
    .test-result.error {
      background: #ffebee;
      border-left-color: #f44336;
    }
    .test-result.warning {
      background: #fff3e0;
      border-left-color: #ff9800;
    }
    .test-result strong {
      display: block;
      margin-bottom: 5px;
    }
    .test-result small {
      color: #666;
      display: block;
    }
    .demo-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 15px;
      font-size: 13px;
    }
    .demo-table th {
      background: #ff6b6b;
      color: white;
      padding: 8px;
      text-align: left;
      font-weight: 600;
    }
    .demo-table td {
      padding: 8px;
      border-bottom: 1px solid #e0e0e0;
      max-width: 300px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    .demo-table tr:hover {
      background: #f5f5f5;
    }
    .rule-code {
      font-family: monospace;
      background: #f0f0f0;
      padding: 2px 4px;
      border-radius: 2px;
    }
    .data-section {
      background: #fafbfc;
      padding: 15px;
      border-radius: 6px;
      margin-top: 15px;
    }
    .summary {
      margin-top: 20px;
      padding: 15px;
      background: #fff3e0;
      border: 2px solid #ff9800;
      border-radius: 6px;
    }
    .summary h3 {
      margin: 0 0 10px 0;
      color: #e65100;
      border: none;
      padding: 0;
    }
    .stats {
      background: #f5f5f5;
      padding: 10px;
      border-radius: 4px;
      margin-top: 10px;
      font-family: monospace;
      font-size: 12px;
    }
  </style>
</head>
<body>
  <div class="test-container">
    <h1>ğŸ“‹ è¦å‰‡è¡¨æ¸¬è©¦</h1>
    <p>é©—è­‰è¦å‰‡è¡¨å¯¦ç¾çš„å®Œæ•´æ€§å’Œæ­£ç¢ºæ€§</p>

    <div id="results"></div>

    <!-- æ¼”ç¤ºå€åŸŸ -->
    <div class="test-section">
      <h3>ğŸ“Š è¦å‰‡è¡¨æ¼”ç¤º</h3>
      <div id="demo"></div>
    </div>

    <!-- è¦å‰‡é¡å‹æ¸¬è©¦ -->
    <div class="test-section">
      <h3>ğŸ·ï¸ è¦å‰‡é¡å‹è­˜åˆ¥</h3>
      <div id="rule-type-tests"></div>
    </div>

    <!-- è¡¨æ ¼æ˜ å°„é©—è­‰ -->
    <div class="test-section">
      <h3>ğŸ—ºï¸ è¡¨æ ¼æ˜ å°„é©—è­‰ï¼ˆä¸‰è¡¨åˆä¸€ï¼‰</h3>
      <div id="mapping-tests"></div>
    </div>
  </div>

  <script src="js/table-renderer.js"></script>
  <script src="js/table-loader.js"></script>
  <script>
    const results = [];

    function logTest(name, success, details) {
      results.push({ name, success, details });
      const resultDiv = document.getElementById('results');
      const testDiv = document.createElement('div');
      testDiv.className = `test-result ${success ? 'success' : 'error'}`;
      testDiv.innerHTML = `<strong>${success ? 'âœ“' : 'âœ—'} ${name}</strong><small>${details}</small>`;
      resultDiv.appendChild(testDiv);
    }

    // ============ æ¸¬è©¦ 1-5: RulesTableAdapter åŸºç¤åŠŸèƒ½ ============

    // æ¸¬è©¦ 1: RulesTableAdapter åˆå§‹åŒ–
    try {
      const adapter = new RulesTableAdapter();
      logTest('RulesTableAdapter åˆå§‹åŒ–', !!adapter, 'æˆåŠŸå‰µå»ºå¯¦ä¾‹');
    } catch (e) {
      logTest('RulesTableAdapter åˆå§‹åŒ–', false, `éŒ¯èª¤: ${e.message}`);
    }

    // æ¸¬è©¦ 2: ç²å–åˆ—å®šç¾©
    try {
      const adapter = new RulesTableAdapter();
      const columns = adapter.getColumns();
      const hasRequiredColumns =
        columns.some(c => c.key === 'rule_name') &&
        columns.some(c => c.key === 'rule_code') &&
        columns.some(c => c.key === 'applicable_condition') &&
        columns.some(c => c.key === 'remarks');
      logTest('åˆ—å®šç¾©å®Œæ•´', hasRequiredColumns, `å®šç¾©äº† ${columns.length} åˆ—`);
    } catch (e) {
      logTest('åˆ—å®šç¾©å®Œæ•´', false, `éŒ¯èª¤: ${e.message}`);
    }

    // æ¸¬è©¦ 3: è¡Œæ•¸æ“šæ ¼å¼åŒ–
    try {
      const adapter = new RulesTableAdapter();
      const row = {
        rule_code: 'R01001',
        rule_name: 'çµ¦ä»˜è¦å‰‡ - åŸºæœ¬æ¢ä»¶',
        applicable_condition: 'é©ç”¨æ–¼æ‰€æœ‰è¨ºç™‚é …ç›®',
        remarks: 'æœ¬è¦å‰‡é©ç”¨æ–¼æ‰€æœ‰è¨ºç™‚é …ç›®ï¼Œæ‚£è€…é ˆç¬¦åˆå¥ä¿çµ¦ä»˜æ¢ä»¶ã€‚'
      };
      const formatted = adapter.formatRow(row);
      const hasAllFields = formatted.rule_code && formatted.rule_name &&
                          formatted.applicable_condition && formatted.remarks;
      logTest('è¡Œæ•¸æ“šæ ¼å¼åŒ–', hasAllFields, `æˆåŠŸæ ¼å¼åŒ– ${Object.keys(formatted).length} å€‹å­—æ®µ`);
    } catch (e) {
      logTest('è¡Œæ•¸æ“šæ ¼å¼åŒ–', false, `éŒ¯èª¤: ${e.message}`);
    }

    // æ¸¬è©¦ 4: æ–‡æœ¬æˆªæ–·
    try {
      const adapter = new RulesTableAdapter();
      const longText = 'é€™æ˜¯ä¸€å€‹éå¸¸é•·çš„æ–‡æœ¬ï¼Œ' + 'x'.repeat(150);
      const row = {
        rule_code: 'R02001',
        rule_name: 'é™åˆ¶æ¢æ¬¾',
        applicable_condition: longText,
        remarks: 'å‚™è¨»'
      };
      const formatted = adapter.formatRow(row);
      const isTruncated = formatted.applicable_condition.includes('...');
      logTest('æ–‡æœ¬æˆªæ–·', isTruncated, 'é•·æ–‡æœ¬å·²æ­£ç¢ºæˆªæ–·é¡¯ç¤º');
    } catch (e) {
      logTest('æ–‡æœ¬æˆªæ–·', false, `éŒ¯èª¤: ${e.message}`);
    }

    // æ¸¬è©¦ 5: è¦å‰‡é¡å‹è­˜åˆ¥
    try {
      const adapter = new RulesTableAdapter();
      const ruleTypes = {
        'R01001': 'çµ¦ä»˜è¦å‰‡',
        'R02001': 'é™åˆ¶æ¢æ¬¾',
        'R03001': 'ç‰¹æ®Šè¦å®š',
        'R04001': 'ä¾‹å¤–æƒ…æ³',
        'R05001': 'ç¦å¿Œ'
      };

      let allCorrect = true;
      for (const [code, expectedType] of Object.entries(ruleTypes)) {
        const actualType = adapter.getRuleTypeLabel(code);
        if (actualType !== expectedType) {
          allCorrect = false;
          break;
        }
      }
      logTest('è¦å‰‡é¡å‹è­˜åˆ¥', allCorrect, 'æ‰€æœ‰è¦å‰‡é¡å‹è­˜åˆ¥æ­£ç¢º');
    } catch (e) {
      logTest('è¦å‰‡é¡å‹è­˜åˆ¥', false, `éŒ¯èª¤: ${e.message}`);
    }

    // ============ è¦å‰‡é¡å‹è©³ç´°æ¸¬è©¦ ============
    const ruleTypeTestsContainer = document.getElementById('rule-type-tests');
    const ruleTypeCases = [
      { code: 'R01001', expected: 'çµ¦ä»˜è¦å‰‡' },
      { code: 'R02001', expected: 'é™åˆ¶æ¢æ¬¾' },
      { code: 'R03001', expected: 'ç‰¹æ®Šè¦å®š' },
      { code: 'R04001', expected: 'ä¾‹å¤–æƒ…æ³' },
      { code: 'R05001', expected: 'ç¦å¿Œ' },
      { code: 'R99001', expected: 'å…¶ä»–' }
    ];

    ruleTypeCases.forEach((testCase, index) => {
      try {
        const adapter = new RulesTableAdapter();
        const result = adapter.getRuleTypeLabel(testCase.code);
        const success = result === testCase.expected;
        const testDiv = document.createElement('div');
        testDiv.className = `test-result ${success ? 'success' : 'warning'}`;
        testDiv.innerHTML = `
          <strong>è¦å‰‡é¡å‹ ${index + 1}: ${testCase.code}</strong>
          <small>é æœŸ: ${testCase.expected} | å¯¦éš›: ${result}</small>
        `;
        ruleTypeTestsContainer.appendChild(testDiv);
      } catch (e) {
        const testDiv = document.createElement('div');
        testDiv.className = 'test-result error';
        testDiv.innerHTML = `<strong>è¦å‰‡é¡å‹æ¸¬è©¦ ${index + 1} å¤±æ•—</strong><small>${e.message}</small>`;
        ruleTypeTestsContainer.appendChild(testDiv);
      }
    });

    // ============ æ¸¬è©¦ 6: åš´é‡è¦å‰‡è­˜åˆ¥ ============
    try {
      const adapter = new RulesTableAdapter();
      const isSevere = adapter.isSevereRule('R05001');
      const isNotSevere = !adapter.isSevereRule('R01001');
      logTest('åš´é‡è¦å‰‡è­˜åˆ¥', isSevere && isNotSevere, 'ç¦å¿Œè¦å‰‡å·²æ­£ç¢ºè­˜åˆ¥');
    } catch (e) {
      logTest('åš´é‡è¦å‰‡è­˜åˆ¥', false, `éŒ¯èª¤: ${e.message}`);
    }

    // ============ è¡¨æ ¼æ˜ å°„é©—è­‰ ============
    const mappingTestsContainer = document.getElementById('mapping-tests');

    // æ¸¬è©¦ 7: åŠ è¼‰è¡¨æ ¼æ˜ å°„
    fetch('data/table-mapping.json')
      .then(response => response.json())
      .then(mapping => {
        try {
          const allHaveThreeTables = Object.values(mapping.mappings).every(section =>
            section.tables && section.tables.length === 3
          );

          const allHaveRulesTable = Object.values(mapping.mappings).every(section =>
            section.tables && section.tables.some(t => t.type === 'rules')
          );

          const testDiv = document.createElement('div');
          testDiv.className = `test-result ${allHaveRulesTable ? 'success' : 'warning'}`;
          testDiv.innerHTML = `
            <strong>âœ“ è¡¨æ ¼æ˜ å°„æ–‡ä»¶åŠ è¼‰æˆåŠŸ</strong>
            <small>
              ç¸½ç¯€é»æ•¸: ${Object.keys(mapping.mappings).length}<br>
              æ¯å€‹ç¯€é»æœ‰ 3 å€‹è¡¨æ ¼: ${allHaveThreeTables ? 'æ˜¯' : 'å¦'}<br>
              æ‰€æœ‰ç¯€é»éƒ½æœ‰è¦å‰‡è¡¨: ${allHaveRulesTable ? 'æ˜¯' : 'å¦'}
            </small>
          `;
          mappingTestsContainer.appendChild(testDiv);

          // è©³ç´°åˆ—å‡ºæ¯å€‹ç¯€é»çš„æ˜ å°„
          const detailDiv = document.createElement('div');
          detailDiv.className = 'data-section';
          detailDiv.innerHTML = '<h4>ç¯€é»æ˜ å°„è©³æƒ…ï¼ˆä¸‰è¡¨åˆä¸€ï¼‰</h4>';

          const table = document.createElement('table');
          table.className = 'demo-table';
          table.innerHTML = '<thead><tr><th>ç¯€é» ID</th><th>ç¯€é»åç¨±</th><th>CSV</th><th>æ¨™æº–</th><th>è¦å‰‡</th></tr></thead><tbody></tbody>';

          Object.entries(mapping.mappings).forEach(([nodeId, section]) => {
            const csvTable = section.tables.find(t => t.type === 'csv');
            const standardTable = section.tables.find(t => t.type === 'standard');
            const rulesTable = section.tables.find(t => t.type === 'rules');

            const row = table.querySelector('tbody').insertRow();
            row.innerHTML = `
              <td><code>${nodeId}</code></td>
              <td>${section.label}</td>
              <td>${csvTable ? 'âœ“' : 'âœ—'}</td>
              <td>${standardTable ? 'âœ“' : 'âœ—'}</td>
              <td>${rulesTable ? 'âœ“ ' + (rulesTable.dataFile || 'N/A') : 'âœ—'}</td>
            `;
          });

          detailDiv.appendChild(table);
          mappingTestsContainer.appendChild(detailDiv);
        } catch (e) {
          const testDiv = document.createElement('div');
          testDiv.className = 'test-result error';
          testDiv.innerHTML = `<strong>âœ— æ˜ å°„é©—è­‰å¤±æ•—</strong><small>${e.message}</small>`;
          mappingTestsContainer.appendChild(testDiv);
        }
      })
      .catch(e => {
        const testDiv = document.createElement('div');
        testDiv.className = 'test-result error';
        testDiv.innerHTML = `<strong>âœ— ç„¡æ³•åŠ è¼‰è¡¨æ ¼æ˜ å°„æ–‡ä»¶</strong><small>${e.message}</small>`;
        mappingTestsContainer.appendChild(testDiv);
      });

    // ============ æ¸¬è©¦ 8: åŠ è¼‰è¦å‰‡è¡¨æ•¸æ“š ============
    const demoContainer = document.getElementById('demo');

    Promise.all([
      fetch('data/rules/section-2-2-1-rules.json').then(r => r.json()),
      fetch('data/rules/section-2-2-3-rules.json').then(r => r.json())
    ])
      .then(([section1, section3]) => {
        try {
          const testDiv = document.createElement('div');
          testDiv.className = 'test-result success';
          testDiv.innerHTML = `
            <strong>âœ“ è¦å‰‡è¡¨æ•¸æ“šåŠ è¼‰æˆåŠŸ</strong>
            <small>
              ç¬¬2-2-1ç¯€: ${section1.total_rules} æ¢è¦å‰‡ (å·²åŠ è¼‰ ${section1.items?.length || 0} æ¢)<br>
              ç¬¬2-2-3ç¯€: ${section3.total_rules} æ¢è¦å‰‡ (å·²åŠ è¼‰ ${section3.items?.length || 0} æ¢)
            </small>
          `;
          demoContainer.appendChild(testDiv);

          // æ¸²æŸ“æ¨£æœ¬è¡¨æ ¼
          const adapter = new RulesTableAdapter();
          const sampleDiv = document.createElement('div');
          sampleDiv.className = 'data-section';
          sampleDiv.innerHTML = '<h4>ç¬¬2-2-1ç¯€æ¨£æœ¬è¦å‰‡ï¼ˆæ‰€æœ‰è¦å‰‡ï¼‰</h4>';

          const table = document.createElement('table');
          table.className = 'demo-table';

          // è¡¨é ­
          const headerRow = table.insertRow();
          adapter.getColumns().forEach(col => {
            const th = document.createElement('th');
            th.textContent = col.label;
            headerRow.appendChild(th);
          });

          // æ•¸æ“šè¡Œ
          section1.items.forEach(item => {
            const formatted = adapter.formatRow(item);
            const row = table.insertRow();
            adapter.getColumns().forEach(col => {
              const cell = row.insertCell();
              const value = formatted[col.key];

              // ç‚ºè¦å‰‡ä»£ç¢¼æ·»åŠ ç‰¹æ®Šæ¨£å¼
              if (col.key === 'rule_code') {
                const span = document.createElement('span');
                span.className = 'rule-code';
                span.textContent = value;
                cell.appendChild(span);
              } else {
                cell.textContent = value || '-';
              }

              if (col.type === 'number') {
                cell.style.textAlign = 'right';
              }
            });
          });

          sampleDiv.appendChild(table);
          demoContainer.appendChild(sampleDiv);
        } catch (e) {
          const testDiv = document.createElement('div');
          testDiv.className = 'test-result error';
          testDiv.innerHTML = `<strong>âœ— æ•¸æ“šæ¸²æŸ“å¤±æ•—</strong><small>${e.message}</small>`;
          demoContainer.appendChild(testDiv);
        }
      })
      .catch(e => {
        const testDiv = document.createElement('div');
        testDiv.className = 'test-result error';
        testDiv.innerHTML = `<strong>âœ— ç„¡æ³•åŠ è¼‰è¦å‰‡è¡¨æ•¸æ“š</strong><small>${e.message}</small>`;
        demoContainer.appendChild(testDiv);
      });

    // ============ é¡¯ç¤ºæ¸¬è©¦æ‘˜è¦ ============
    setTimeout(() => {
      const passed = results.filter(r => r.success).length;
      const total = results.length;
      const summary = document.createElement('div');
      summary.className = 'summary';
      summary.innerHTML = `
        <h3>âœ“ æ¸¬è©¦æ‘˜è¦</h3>
        <p><strong>é€šé: ${passed}/${total}</strong></p>
        <p>è¦å‰‡è¡¨å¯¦ç¾å·²é©—è­‰ï¼</p>
        ${passed === total ? '<p style="color: #e65100;">âœ“ æ‰€æœ‰æ¸¬è©¦é€šé - ä¸‰è¡¨åˆä¸€ç³»çµ±å®Œæˆ</p>' : ''}
      `;
      document.getElementById('results').insertBefore(summary, document.getElementById('results').firstChild);
    }, 500);
  </script>
</body>
</html>
