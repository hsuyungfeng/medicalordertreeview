# Tasks: Refactor Content Display Architecture

## Phase 1: 基礎設施建設

### 1.1 創建節點-表單映射系統
- [ ] 1.1.1 設計 `table-mapper.js` 模塊結構
- [ ] 1.1.2 創建 `data/table-mapping.json` 配置文件（基於 section-2-2-N）
- [ ] 1.1.3 實現 `TableMapper` 類
  - 加載映射配置
  - 查詢節點對應的表格列表
  - 驗證映射完整性
- [ ] 1.1.4 測試：驗證映射查詢正確

### 1.2 創建通用表格加載系統
- [ ] 1.2.1 創建 `table-loader.js` 模塊
- [ ] 1.2.2 實現 `TableLoader` 類
  - 根據表格配置加載數據
  - 支持多種數據來源（CSV chunks、JSON 文件、內存數據）
  - 實現緩存機制
- [ ] 1.2.3 測試：驗證不同類型數據源的加載

### 1.3 升級表格渲染系統
- [ ] 1.3.1 重構現有 `csv-table-renderer.js` 為 `table-renderer.js`
- [ ] 1.3.2 提取通用渲染邏輯（排序、篩選、分頁、HTML 轉義）
- [ ] 1.3.3 實現表格適配器接口
  - `CSVTableAdapter` - CSV 診療項目表
  - `StandardTableAdapter` - 支付標準表
  - `RulesTableAdapter` - 規則表
- [ ] 1.3.4 測試：驗證各種適配器正確工作

---

## Phase 2: 左側面板優化

### 2.1 實現內容提取邏輯
- [ ] 2.1.1 分析現有文檔結構
  - 檢查 3-5 個文檔樣本
  - 識別「說明」、「通則」、「細節規則」的位置
- [ ] 2.1.2 設計提取算法
  - 選擇提取策略（關鍵詞分割 / 前 N 段 / 前 M 字符）
  - 編寫規則表達式或邏輯
- [ ] 2.1.3 實現 `ContentExtractor` 類
  - `extractSummary(fullContent)` - 提取說明
  - `extractFull(fullContent)` - 保留完整內容
- [ ] 2.1.4 測試：驗證提取結果質量

### 2.2 修改左側面板顯示邏輯
- [ ] 2.2.1 修改 `tree-loader.js:showNodeDetails()` 方法
  - 將 `node.content` 改為使用提取後的摘要
  - 保留完整內容在隱藏狀態
- [ ] 2.2.2 添加「展開全文」按鈕
  - 點擊切換顯示完整內容
  - 按鈕文本：「展開全文」/ 「收起」
- [ ] 2.2.3 更新 CSS：調整詳情面板佈局
- [ ] 2.2.4 測試：驗證展開/收起功能

### 2.3 優化用戶體驗
- [ ] 2.3.1 添加過度動畫（content 展開時）
- [ ] 2.3.2 保存用戶展開狀態（localStorage 可選）
- [ ] 2.3.3 測試跨瀏覽器相容性

---

## Phase 3: 右側面板多表格支持

### 3.1 實現表格標籤系統
- [ ] 3.1.1 修改 HTML：添加標籤欄容器
  ```html
  <div class="table-tabs">
    <button class="tab-button active" data-table-id="...">表1</button>
    <button class="tab-button" data-table-id="...">表2</button>
  </div>
  ```
- [ ] 3.1.2 實現標籤點擊邏輯
- [ ] 3.1.3 CSS：標籤樣式設計
- [ ] 3.1.4 測試：驗證標籤切換

### 3.2 集成 CSV 表到新架構
- [ ] 3.2.1 將 CSV 表改為通過 `TableRenderer` + `CSVTableAdapter` 顯示
- [ ] 3.2.2 測試：確保現有功能不破裂
  - 排序
  - 篩選
  - 項目計數

### 3.3 添加支付標準表支持
- [ ] 3.3.1 獲取或構建支付標準表數據結構
  - 檢查是否已有結構化數據
  - 設計表列（代碼、項目名、標準點數、規則等）
- [ ] 3.3.2 實現 `StandardTableAdapter`
- [ ] 3.3.3 完善 `table-mapping.json`，為相關節點添加支付標準表映射
- [ ] 3.3.4 測試：驗證支付標準表正確顯示

### 3.4 添加規則表支持
- [ ] 3.4.1 獲取或構建規則表數據
  - 提取文檔中的規則表（如果以表格形式存在）
  - 或構造規則對應表
- [ ] 3.4.2 實現 `RulesTableAdapter`
- [ ] 3.4.3 完善 `table-mapping.json`，為相關節點添加規則表映射
- [ ] 3.4.4 測試：驗證規則表正確顯示

### 3.5 處理無表格的節點
- [ ] 3.5.1 實現「無相關表格」提示文案
- [ ] 3.5.2 在右側面板顯示提示
- [ ] 3.5.3 測試：驗證提示出現

---

## Phase 4: 集成與優化

### 4.1 模塊整合
- [ ] 4.1.1 更新 HTML 引入新的 JavaScript 模塊
  ```html
  <script src="js/table-mapper.js"></script>
  <script src="js/table-loader.js"></script>
  <script src="js/table-renderer.js"></script>
  ```
- [ ] 4.1.2 修改 `app.js` 初始化流程
  - 加載映射配置
  - 初始化 TableMapper 和 TableLoader
- [ ] 4.1.3 修改 `tree-loader.js` 的 `showNodeDetails()` 集成多表格邏輯

### 4.2 性能優化
- [ ] 4.2.1 實現表格級別緩存
  - 加載過的表格數據保存在內存
  - 用戶重新點擊相同節點時，從緩存返回
- [ ] 4.2.2 實現懶加載
  - 只在用戶點擊標籤時加載相應表格
  - 減少初始化時間
- [ ] 4.2.3 測試：測量初始化時間和表格切換響應時間

### 4.3 邊界情況處理
- [ ] 4.3.1 處理表格加載失敗
  - 顯示「表格加載失敗，請稍後重試」
  - 提供重試按鈕
- [ ] 4.3.2 處理映射配置缺失
  - Log 警告
  - 優雅降級（顯示備選表或提示）
- [ ] 4.3.3 處理空表格數據
  - 顯示「此表格無數據」

### 4.4 端到端測試
- [ ] 4.4.1 測試場景 1：點擊節點 → 顯示對應表格
  - 左側：簡化說明
  - 右側：相應表格
- [ ] 4.4.2 測試場景 2：節點有多個表格 → 標籤切換
- [ ] 4.4.3 測試場景 3：展開/收起全文
- [ ] 4.4.4 測試場景 4：表格排序、篩選、計數
- [ ] 4.4.5 跨瀏覽器測試（Chrome、Firefox、Safari）

### 4.5 文檔更新
- [ ] 4.5.1 更新 IMPLEMENTATION_COMPLETE.md
- [ ] 4.5.2 編寫開發文檔：如何添加新的表格類型
- [ ] 4.5.3 編寫用戶文檔：新功能說明

---

## Phase 5: 驗證與部署

### 5.1 代碼審查
- [ ] 5.1.1 檢查代碼風格一致性
- [ ] 5.1.2 檢查是否有 console.log（移除或保留必要的日誌）
- [ ] 5.1.3 檢查事件監聽器管理（避免內存洩漏）

### 5.2 性能驗證
- [ ] 5.2.1 測量頁面加載時間
- [ ] 5.2.2 測量表格切換延遲
- [ ] 5.2.3 測量內存使用情況

### 5.3 可訪問性檢查
- [ ] 5.3.1 驗證標籤欄的鍵盤導航
- [ ] 5.3.2 驗證屏幕閱讀器支持（ARIA labels）
- [ ] 5.3.3 驗證顏色對比度

### 5.4 最終測試清單
- [ ] ✅ 功能測試完畢
- [ ] ✅ 性能測試完畢
- [ ] ✅ 跨瀏覽器測試完畢
- [ ] ✅ 可訪問性檢查完畢
- [ ] ✅ 代碼審查完畢
- [ ] ✅ 文檔更新完畢

---

## 估算與優先級

### 高優先級（必須完成）
- Phase 1：基礎設施建設（表格系統）
- Phase 2.1-2.2：左側面板優化
- Phase 3.1-3.2：表格標籤與 CSV 遷移

### 中優先級（應該完成）
- Phase 3.3-3.4：支付標準表和規則表
- Phase 4.1-4.3：集成與優化

### 低優先級（可選）
- Phase 4.4 中的跨瀏覽器測試細節
- Phase 5.3 的高級可訪問性

---

## 依賴與並行化

### 可並行的任務
- 1.2 和 1.3 可與 2.1 並行進行
- 3.3 和 3.4 的實現可并行

### 順序依賴
- 1.1 必須完成後才能進行 3.x
- 2.2 需要依賴 2.1 的完成

---

## 驗證準則

每個階段完成後，應確認：
- 功能正確性：所有需求都已實現
- 向後相容：現有功能仍然正常
- 性能：沒有性能回退
- 代碼質量：無錯誤、無洩漏
